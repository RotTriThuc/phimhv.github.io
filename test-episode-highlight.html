<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Test Episode Highlighter</title>
  <style>
    body {
      background: #0a0a0a;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    
    .episode-list {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .episode-btn {
      background: #1a1a1a;
      border: 1px solid #333;
      color: white;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
    }
    
    .episode-btn:hover {
      background: #2a2a2a;
    }
    
    .test-info {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    button {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #5b4bc7;
    }
    
    #log {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¯ Test Episode Highlighter</h1>
  
  <div class="test-info">
    <h3>Current Movie:</h3>
    <p>Slug: <strong id="current-slug">ha-noi-vietsub</strong></p>
    <input type="text" id="slug-input" value="ha-noi-vietsub" 
           style="width: 300px; padding: 8px; background: #2a2a2a; color: white; border: 1px solid #444;">
    <button onclick="updateSlug()">Update Slug</button>
  </div>

  <div>
    <button onclick="testFirebase()">1. Test Firebase</button>
    <button onclick="testProgress()">2. Test Watch Progress</button>
    <button onclick="testElements()">3. Test Episode Elements</button>
    <button onclick="runHighlighter()">4. Run Highlighter</button>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <h2>ðŸ“º Danh sÃ¡ch táº­p (Test)</h2>
  <div class="episode-list" id="episode-list">
    <!-- Will be generated by JS -->
  </div>

  <h2>ðŸ“‹ Debug Log:</h2>
  <div id="log"></div>

  <script type="module">
    import { highlightCurrentEpisode, getCurrentEpisodeInfo } from './modules/episode-highlighter.js';

    let currentSlug = 'ha-noi-vietsub';

    // Generate test episodes
    function generateEpisodes() {
      const container = document.getElementById('episode-list');
      container.innerHTML = '';
      
      for (let i = 1; i <= 50; i++) {
        const btn = document.createElement('button');
        btn.className = 'episode-btn';
        btn.textContent = `Táº­p ${i.toString().padStart(2, '0')}`;
        btn.dataset.slug = `tap-${i}`;
        btn.onclick = () => log(`Clicked: Táº­p ${i}`);
        container.appendChild(btn);
      }
      
      log(`âœ… Generated 50 episodes`);
    }

    // Log function
    window.log = function(message) {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${message}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    };

    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
    };

    // Test 1: Firebase
    window.testFirebase = function() {
      log('ðŸ” Testing Firebase...');
      
      if (window.movieComments) {
        log('âœ… Firebase initialized');
        log(`   - initialized: ${window.movieComments.initialized}`);
        log(`   - db: ${!!window.movieComments.db}`);
      } else {
        log('âŒ Firebase NOT initialized');
        log('   Solution: Make sure firebase-config.js is loaded');
      }
    };

    // Test 2: Watch Progress
    window.testProgress = async function() {
      log('ðŸ” Testing watch progress...');
      
      if (!window.movieComments) {
        log('âŒ Firebase not ready');
        return;
      }

      try {
        const progress = await window.movieComments.getWatchProgress(currentSlug);
        
        if (progress) {
          log('âœ… Found watch progress:');
          log(`   - Episode: ${progress.episodeName} (${progress.episodeSlug})`);
          log(`   - Progress: ${Math.floor(progress.progress * 100)}%`);
          log(`   - Time: ${progress.currentTime}s / ${progress.duration}s`);
        } else {
          log('âš ï¸ No watch progress found');
          log('   Solution: Watch the movie for at least 10 seconds');
        }
      } catch (error) {
        log(`âŒ Error: ${error.message}`);
      }
    };

    // Test 3: Episode Elements
    window.testElements = function() {
      log('ðŸ” Testing episode elements...');
      
      const container = document.querySelector('.episode-list');
      if (!container) {
        log('âŒ Episode container not found');
        return;
      }
      
      log('âœ… Container found');
      
      const episodes = container.querySelectorAll('[data-slug]');
      log(`âœ… Found ${episodes.length} episodes with data-slug`);
      
      if (episodes.length > 0) {
        log(`   First episode: ${episodes[0].dataset.slug}`);
        log(`   Last episode: ${episodes[episodes.length - 1].dataset.slug}`);
      }
      
      const tap3 = container.querySelector('[data-slug="tap-3"]');
      if (tap3) {
        log('âœ… Found Táº­p 3 element');
        log(`   - text: ${tap3.textContent}`);
        log(`   - slug: ${tap3.dataset.slug}`);
      } else {
        log('âŒ Táº­p 3 not found');
      }
    };

    // Test 4: Run Highlighter
    window.runHighlighter = async function() {
      log('ðŸš€ Running highlighter...');
      
      try {
        const result = await highlightCurrentEpisode(
          currentSlug,
          '.episode-list',
          {
            scrollToEpisode: true,
            showBadge: true
          }
        );
        
        if (result) {
          log('âœ… Highlight successful!');
          log(`   - Episode: ${result.episodeName}`);
          log(`   - Slug: ${result.episodeSlug}`);
          log(`   - Progress: ${Math.floor(result.progress * 100)}%`);
          log(`   - Element: ${result.element ? 'Found' : 'Not found'}`);
          
          if (result.element) {
            log(`   - Element classes: ${result.element.className}`);
          }
        } else {
          log('âš ï¸ No episode to highlight');
          log('   Possible reasons:');
          log('   - No watch progress for this movie');
          log('   - Episode element not found in DOM');
        }
      } catch (error) {
        log(`âŒ Error: ${error.message}`);
        console.error(error);
      }
    };

    // Update slug
    window.updateSlug = function() {
      currentSlug = document.getElementById('slug-input').value;
      document.getElementById('current-slug').textContent = currentSlug;
      log(`ðŸ“ Updated slug to: ${currentSlug}`);
    };

    // Auto-run on load
    window.addEventListener('DOMContentLoaded', () => {
      log('ðŸŽ¬ Page loaded');
      generateEpisodes();
      
      // Auto test after 1 second
      setTimeout(() => {
        log('');
        log('=== AUTO-TESTING ===');
        testFirebase();
        setTimeout(() => testProgress(), 500);
        setTimeout(() => testElements(), 1000);
      }, 1000);
    });
  </script>
</body>
</html>
