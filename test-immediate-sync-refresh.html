<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Immediate Sync Refresh</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .status.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
    .status.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
    .status.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
    
    .timeline {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }
    
    .timeline-item:last-child {
      border-bottom: none;
    }
    
    .timeline-time {
      font-family: monospace;
      font-size: 12px;
      color: #888;
      min-width: 80px;
    }
    
    .timeline-status {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .timeline-status.pending { background: #666; }
    .timeline-status.success { background: #00b894; }
    .timeline-status.error { background: #e74c3c; }
    
    .movie-count {
      background: #333;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
    }
    
    .movie-count-number {
      font-size: 48px;
      font-weight: bold;
      color: #6c5ce7;
    }
    
    .sync-input {
      width: 150px;
      padding: 10px;
      border: 1px solid #555;
      border-radius: 6px;
      background: #333;
      color: #fff;
      text-align: center;
      font-size: 18px;
      letter-spacing: 2px;
      margin: 10px;
    }
    
    .log-area {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 250px;
      overflow-y: auto;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Test Immediate Sync Refresh</h1>
    <p>Test xem phim cÃ³ hiá»ƒn thá»‹ ngay láº­p tá»©c sau khi sync khÃ´ng</p>
    
    <!-- Current Status -->
    <div class="test-section">
      <h3>ğŸ“Š Current Status</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
        
        <div class="movie-count">
          <div class="movie-count-number" id="current-movie-count">0</div>
          <div>Phim hiá»‡n táº¡i</div>
        </div>
        
        <div class="movie-count">
          <div class="movie-count-number" id="cache-status">â“</div>
          <div>Cache Status</div>
        </div>
        
        <div class="movie-count">
          <div class="movie-count-number" id="user-status">ğŸ‘¤</div>
          <div>User Status</div>
        </div>
        
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
        <button class="btn" onclick="refreshStatus()">ğŸ”„ Refresh Status</button>
        <button class="btn" onclick="clearAllCaches()">ğŸ—‘ï¸ Clear All Caches</button>
        <button class="btn" onclick="testImmediateRefresh()">ğŸš€ Test Immediate Refresh</button>
      </div>
    </div>

    <!-- Sync Test Timeline -->
    <div class="test-section">
      <h3>â±ï¸ Sync Test Timeline</h3>
      <p>Theo dÃµi tá»«ng bÆ°á»›c cá»§a quÃ¡ trÃ¬nh sync</p>
      
      <div class="timeline" id="sync-timeline">
        <div class="timeline-item">
          <div class="timeline-time">00:00</div>
          <div class="timeline-status pending">â³</div>
          <div>Waiting for sync test...</div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
        <button class="btn btn--success" onclick="startSyncTest()">ğŸš€ Start Sync Test</button>
        <input type="text" id="test-sync-code" class="sync-input" placeholder="123456" maxlength="6">
        <button class="btn" onclick="clearTimeline()">ğŸ—‘ï¸ Clear Timeline</button>
      </div>
    </div>

    <!-- Manual Tests -->
    <div class="test-section">
      <h3>ğŸ§ª Manual Tests</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <!-- Setup Tests -->
        <div>
          <h4>ğŸ”§ Setup Tests</h4>
          <button class="btn" onclick="addTestMovies()">â• Add Test Movies</button>
          <button class="btn" onclick="generateTestSyncCode()">ğŸ“¤ Generate Sync Code</button>
          <button class="btn" onclick="simulateUserChange()">ğŸ‘¤ Simulate User Change</button>
          
          <div id="setup-results" style="margin-top: 10px;"></div>
        </div>
        
        <!-- Refresh Tests -->
        <div>
          <h4>ğŸ”„ Refresh Tests</h4>
          <button class="btn" onclick="testCacheInvalidation()">ğŸ—‘ï¸ Test Cache Clear</button>
          <button class="btn" onclick="testUIRefresh()">ğŸ¨ Test UI Refresh</button>
          <button class="btn" onclick="testFullRefresh()">ğŸš€ Test Full Refresh</button>
          
          <div id="refresh-results" style="margin-top: 10px;"></div>
        </div>
        
      </div>
    </div>

    <!-- Debug Log -->
    <div class="test-section">
      <h3>ğŸ“ Debug Log</h3>
      <div class="log-area" id="debug-log">
        Debug messages will appear here...
      </div>
      <button class="btn" onclick="clearDebugLog()">ğŸ—‘ï¸ Clear Log</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    let debugMessages = [];
    let syncStartTime = null;
    let testSyncCode = null;
    
    // Capture console
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function captureConsole() {
      ['log', 'error', 'warn'].forEach(method => {
        console[method] = function(...args) {
          const message = args.join(' ');
          debugMessages.push(`[${method.toUpperCase()}] ${message}`);
          updateDebugLog();
          originalConsole[method].apply(console, args);
        };
      });
    }
    
    function updateDebugLog() {
      const debugLog = document.getElementById('debug-log');
      const recent = debugMessages.slice(-20);
      debugLog.innerHTML = recent.map(msg => `<div>${msg}</div>`).join('');
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    function clearDebugLog() {
      debugMessages = [];
      updateDebugLog();
    }
    
    function addDebugMessage(message) {
      debugMessages.push(`[TEST] ${message}`);
      updateDebugLog();
    }
    
    function addTimelineItem(message, status = 'pending') {
      const timeline = document.getElementById('sync-timeline');
      const time = syncStartTime ? ((Date.now() - syncStartTime) / 1000).toFixed(1) + 's' : '00:00';
      
      const item = document.createElement('div');
      item.className = 'timeline-item';
      item.innerHTML = `
        <div class="timeline-time">${time}</div>
        <div class="timeline-status ${status}">${status === 'success' ? 'âœ…' : status === 'error' ? 'âŒ' : 'â³'}</div>
        <div>${message}</div>
      `;
      
      timeline.appendChild(item);
      timeline.scrollTop = timeline.scrollHeight;
    }
    
    function clearTimeline() {
      document.getElementById('sync-timeline').innerHTML = `
        <div class="timeline-item">
          <div class="timeline-time">00:00</div>
          <div class="timeline-status pending">â³</div>
          <div>Timeline cleared, ready for new test...</div>
        </div>
      `;
      syncStartTime = null;
    }
    
    async function refreshStatus() {
      try {
        // Movie count
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          document.getElementById('current-movie-count').textContent = movies.length;
        }
        
        // Cache status
        const cacheValid = window.Storage?._savedMoviesCache !== null;
        document.getElementById('cache-status').textContent = cacheValid ? 'âœ…' : 'âŒ';
        
        // User status
        const userName = window.movieComments?.getUserName() || 'Unknown';
        document.getElementById('user-status').textContent = userName.charAt(0).toUpperCase();
        
        addDebugMessage(`ğŸ“Š Status refreshed - Movies: ${document.getElementById('current-movie-count').textContent}, Cache: ${cacheValid}, User: ${userName}`);
        
      } catch (error) {
        addDebugMessage(`âŒ Status refresh error: ${error.message}`);
      }
    }
    
    function clearAllCaches() {
      if (window.Storage) {
        window.Storage._savedMoviesCache = null;
        window.Storage._watchProgressCache = null;
        window.Storage._lastCacheUpdate = 0;
      }
      localStorage.removeItem('savedMovies');
      localStorage.removeItem('watchProgress');
      
      addDebugMessage('ğŸ—‘ï¸ All caches cleared');
      refreshStatus();
    }
    
    async function testImmediateRefresh() {
      try {
        addDebugMessage('ğŸš€ Testing immediate refresh...');
        
        if (window.immediateRefreshSavedMovies) {
          const result = await window.immediateRefreshSavedMovies();
          addDebugMessage(`âœ… Immediate refresh result: ${result}`);
        } else {
          addDebugMessage('âŒ immediateRefreshSavedMovies function not found');
        }
        
        refreshStatus();
      } catch (error) {
        addDebugMessage(`âŒ Immediate refresh test error: ${error.message}`);
      }
    }
    
    async function startSyncTest() {
      const syncCode = document.getElementById('test-sync-code').value.trim();
      if (!syncCode) {
        alert('âŒ Please enter a sync code');
        return;
      }
      
      syncStartTime = Date.now();
      clearTimeline();
      
      addTimelineItem('ğŸš€ Starting sync test...', 'pending');
      addTimelineItem(`ğŸ“ Using sync code: ${syncCode}`, 'pending');
      
      try {
        // Step 1: Record before state
        const beforeMovies = await window.Storage?.getSavedMovies() || [];
        const beforeUser = window.movieComments?.getUserName() || 'Unknown';
        addTimelineItem(`ğŸ“Š Before sync: ${beforeMovies.length} movies, user: ${beforeUser}`, 'success');
        
        // Step 2: Apply sync code
        addTimelineItem('ğŸ”„ Applying sync code...', 'pending');
        
        if (window.movieComments && window.movieComments.useSyncCode) {
          const result = await window.movieComments.useSyncCode(syncCode);
          addTimelineItem(`âœ… Sync successful with: ${result.userName}`, 'success');
          
          // Step 3: Check immediate state
          const afterUser = window.movieComments.getUserName();
          addTimelineItem(`ğŸ‘¤ User changed to: ${afterUser}`, 'success');
          
          // Step 4: Check movies immediately
          const immediateMovies = await window.Storage.getSavedMovies();
          addTimelineItem(`ğŸ“š Immediate movie count: ${immediateMovies.length}`, immediateMovies.length > 0 ? 'success' : 'error');
          
          // Step 5: Test immediate refresh
          if (window.immediateRefreshSavedMovies) {
            addTimelineItem('ğŸš€ Testing immediate refresh...', 'pending');
            const refreshResult = await window.immediateRefreshSavedMovies();
            addTimelineItem(`ğŸ¯ Immediate refresh: ${refreshResult ? 'SUCCESS' : 'FAILED'}`, refreshResult ? 'success' : 'error');
          }
          
          // Step 6: Final check
          const finalMovies = await window.Storage.getSavedMovies();
          addTimelineItem(`ğŸ Final movie count: ${finalMovies.length}`, finalMovies.length > 0 ? 'success' : 'error');
          
          // Update status
          refreshStatus();
          
        } else {
          addTimelineItem('âŒ useSyncCode function not available', 'error');
        }
        
      } catch (error) {
        addTimelineItem(`âŒ Sync test failed: ${error.message}`, 'error');
        addDebugMessage(`âŒ Sync test error: ${error.message}`);
      }
    }
    
    async function addTestMovies() {
      try {
        const testMovies = [
          { slug: 'test-movie-1', name: 'Test Movie 1', year: 2025 },
          { slug: 'test-movie-2', name: 'Test Movie 2', year: 2025 },
          { slug: 'test-movie-3', name: 'Test Movie 3', year: 2025 }
        ];
        
        for (const movie of testMovies) {
          await window.Storage?.saveMovie(movie);
        }
        
        document.getElementById('setup-results').innerHTML = `
          <div class="status success">âœ… Added ${testMovies.length} test movies</div>
        `;
        
        addDebugMessage(`â• Added ${testMovies.length} test movies`);
        refreshStatus();
        
      } catch (error) {
        document.getElementById('setup-results').innerHTML = `
          <div class="status error">âŒ Error: ${error.message}</div>
        `;
        addDebugMessage(`âŒ Add test movies error: ${error.message}`);
      }
    }
    
    function generateTestSyncCode() {
      try {
        if (window.movieComments && window.movieComments.generateSyncCode) {
          testSyncCode = window.movieComments.generateSyncCode();
          document.getElementById('test-sync-code').value = testSyncCode;
          
          document.getElementById('setup-results').innerHTML = `
            <div class="status success">âœ… Generated sync code: ${testSyncCode}</div>
          `;
          
          addDebugMessage(`ğŸ“¤ Generated sync code: ${testSyncCode}`);
        } else {
          document.getElementById('setup-results').innerHTML = `
            <div class="status error">âŒ generateSyncCode not available</div>
          `;
        }
      } catch (error) {
        addDebugMessage(`âŒ Generate sync code error: ${error.message}`);
      }
    }
    
    function simulateUserChange() {
      const newUserId = 'test_user_' + Date.now();
      localStorage.setItem('movie_commenter_id', newUserId);
      sessionStorage.setItem('movie_commenter_id', newUserId);
      
      document.getElementById('setup-results').innerHTML = `
        <div class="status info">ğŸ”„ Simulated user change to: ${newUserId.substring(0, 20)}...</div>
      `;
      
      addDebugMessage(`ğŸ‘¤ Simulated user change to: ${newUserId}`);
      refreshStatus();
    }
    
    async function testCacheInvalidation() {
      try {
        // Check cache before
        const cacheBefore = window.Storage?._savedMoviesCache !== null;
        
        // Clear cache
        clearAllCaches();
        
        // Check cache after
        const cacheAfter = window.Storage?._savedMoviesCache !== null;
        
        document.getElementById('refresh-results').innerHTML = `
          <div class="status ${!cacheAfter ? 'success' : 'error'}">
            Cache before: ${cacheBefore ? 'âœ…' : 'âŒ'}<br>
            Cache after: ${cacheAfter ? 'âœ…' : 'âŒ'}
          </div>
        `;
        
        addDebugMessage(`ğŸ—‘ï¸ Cache invalidation test - Before: ${cacheBefore}, After: ${cacheAfter}`);
        
      } catch (error) {
        addDebugMessage(`âŒ Cache invalidation test error: ${error.message}`);
      }
    }
    
    async function testUIRefresh() {
      try {
        if (window.refreshSavedMoviesAfterSync) {
          await window.refreshSavedMoviesAfterSync();
          
          document.getElementById('refresh-results').innerHTML = `
            <div class="status success">âœ… UI refresh completed</div>
          `;
          
          addDebugMessage('ğŸ¨ UI refresh test completed');
        } else {
          document.getElementById('refresh-results').innerHTML = `
            <div class="status error">âŒ refreshSavedMoviesAfterSync not found</div>
          `;
        }
      } catch (error) {
        addDebugMessage(`âŒ UI refresh test error: ${error.message}`);
      }
    }
    
    async function testFullRefresh() {
      try {
        if (window.immediateRefreshSavedMovies) {
          const result = await window.immediateRefreshSavedMovies();
          
          document.getElementById('refresh-results').innerHTML = `
            <div class="status ${result ? 'success' : 'error'}">
              ${result ? 'âœ…' : 'âŒ'} Full refresh result: ${result}
            </div>
          `;
          
          addDebugMessage(`ğŸš€ Full refresh test result: ${result}`);
          refreshStatus();
        } else {
          document.getElementById('refresh-results').innerHTML = `
            <div class="status error">âŒ immediateRefreshSavedMovies not found</div>
          `;
        }
      } catch (error) {
        addDebugMessage(`âŒ Full refresh test error: ${error.message}`);
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      captureConsole();
      
      // Initial status check
      setTimeout(() => {
        refreshStatus();
        addDebugMessage('ğŸš€ Test system initialized');
      }, 2000);
      
      // Auto-refresh status every 10 seconds
      setInterval(() => {
        refreshStatus();
      }, 10000);
    });
    
    // Auto-format sync code input
    document.getElementById('test-sync-code').oninput = (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    };
  </script>
</body>
</html>
