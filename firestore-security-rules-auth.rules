rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // üîê SAVED MOVIES COLLECTION - User Auth Required
    match /savedMovies/{document=**} {
      // Cho ph√©p ƒë·ªçc n·∫øu:
      // 1. User ƒë√£ ƒëƒÉng nh·∫≠p V√Ä document thu·ªôc v·ªÅ user ƒë√≥
      // 2. Ho·∫∑c l√† guest user (fallback cho compatibility)
      allow read: if request.auth != null && resource.data.userId == request.auth.uid
                  || resource.data.userId.matches('user_primary_.*');
      
      // Cho ph√©p t·∫°o/c·∫≠p nh·∫≠t n·∫øu:
      // 1. User ƒë√£ ƒëƒÉng nh·∫≠p V√Ä userId trong document kh·ªõp v·ªõi auth UID
      allow create, update: if request.auth != null 
                            && request.resource.data.userId == request.auth.uid;
      
      // Cho ph√©p x√≥a n·∫øu:
      // 1. User ƒë√£ ƒëƒÉng nh·∫≠p V√Ä document thu·ªôc v·ªÅ user ƒë√≥
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
    
    // üì∫ WATCH PROGRESS COLLECTION - User Auth Required
    match /watchProgress/{document=**} {
      // Same rules as savedMovies
      allow read: if request.auth != null && resource.data.userId == request.auth.uid
                  || resource.data.userId.matches('user_primary_.*');
      
      allow create, update: if request.auth != null 
                            && request.resource.data.userId == request.auth.uid;
      
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
    
    // üîÑ SYNC CODES COLLECTION - For cross-device sync
    match /syncCodes/{syncCode} {
      // Ai c≈©ng c√≥ th·ªÉ ƒë·ªçc sync code (ƒë·ªÉ verify)
      allow read: if true;
      
      // Ch·ªâ authenticated user c√≥ th·ªÉ t·∫°o sync code
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // Ch·ªâ owner ho·∫∑c ng∆∞·ªùi d√πng code m·ªõi c√≥ th·ªÉ update (mark as used)
      allow update: if request.auth != null;
      
      // Ch·ªâ owner c√≥ th·ªÉ x√≥a
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
    }
    
    // üí¨ COMMENTS COLLECTION - Public read, Auth write
    match /comments/{document=**} {
      // Ai c≈©ng c√≥ th·ªÉ ƒë·ªçc comments
      allow read: if true;
      
      // Ch·ªâ authenticated user c√≥ th·ªÉ t·∫°o comment
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      
      // Ch·ªâ owner ho·∫∑c admin c√≥ th·ªÉ c·∫≠p nh·∫≠t
      allow update: if request.auth != null 
                    && (resource.data.userId == request.auth.uid 
                        || request.auth.token.admin == true);
      
      // Ch·ªâ owner ho·∫∑c admin c√≥ th·ªÉ x√≥a
      allow delete: if request.auth != null 
                    && (resource.data.userId == request.auth.uid 
                        || request.auth.token.admin == true);
    }
    
    // üëç LIKES COLLECTION - User specific
    match /likes/{document=**} {
      allow read: if true;
      
      allow create, update, delete: if request.auth != null 
                                    && request.resource.data.userId == request.auth.uid;
    }
    
    // üö® REPORTS COLLECTION - Auth required to create
    match /reports/{document=**} {
      // Ch·ªâ admin c√≥ th·ªÉ ƒë·ªçc reports
      allow read: if request.auth != null && request.auth.token.admin == true;
      
      // Authenticated user c√≥ th·ªÉ t·∫°o report
      allow create: if request.auth != null;
      
      // Ch·ªâ admin c√≥ th·ªÉ update/delete
      allow update, delete: if request.auth != null && request.auth.token.admin == true;
    }
    
    // üìä USER PROFILES COLLECTION (Optional)
    match /userProfiles/{userId} {
      // User c√≥ th·ªÉ ƒë·ªçc profile c·ªßa ch√≠nh m√¨nh
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // User c√≥ th·ªÉ t·∫°o/c·∫≠p nh·∫≠t profile c·ªßa ch√≠nh m√¨nh
      allow create, update: if request.auth != null && request.auth.uid == userId;
      
      // Kh√¥ng cho ph√©p x√≥a profile
      allow delete: if false;
    }
    
    // üîî NOTIFICATIONS COLLECTION
    match /notifications/{userId}/items/{notificationId} {
      // User ch·ªâ c√≥ th·ªÉ ƒë·ªçc notification c·ªßa m√¨nh
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // System c√≥ th·ªÉ t·∫°o notification (admin only)
      allow create: if request.auth != null && request.auth.token.admin == true;
      
      // User c√≥ th·ªÉ update status (read/unread)
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // User c√≥ th·ªÉ x√≥a notification c·ªßa m√¨nh
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // ‚öôÔ∏è SYSTEM COLLECTIONS - Admin only
    match /system/{document=**} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }
    
    // üö´ Block all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
