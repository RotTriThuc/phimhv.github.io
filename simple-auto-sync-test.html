<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Auto-Sync Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .test-box {
      background: #1e1e1e;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .test-box.success {
      border-color: #00b894;
      background: rgba(0, 184, 148, 0.1);
    }
    
    .test-box.error {
      border-color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 10px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    
    .info-display {
      background: #2a2a2a;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 12px;
    }
    
    .step {
      margin: 10px 0;
      padding: 10px;
      background: #333;
      border-radius: 4px;
      border-left: 4px solid #6c5ce7;
    }
    
    .step.success {
      border-left-color: #00b894;
      background: rgba(0, 184, 148, 0.1);
    }
    
    .step.error {
      border-left-color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Simple Auto-Sync Test</h1>
    <p>Test auto-sync gi·ªØa tr√¨nh duy·ªát tr√™n GitHub Pages</p>
    
    <!-- Current Status -->
    <div class="test-box" id="status-box">
      <h3>üìä Current Status</h3>
      
      <div class="info-display" id="current-info">
        <div>Loading current information...</div>
      </div>
      
      <button class="btn" onclick="loadCurrentInfo()">üîÑ Refresh Info</button>
    </div>

    <!-- Auto-Sync Test -->
    <div class="test-box" id="auto-sync-box">
      <h3>üöÄ Auto-Sync Test</h3>
      
      <div id="auto-sync-steps">
        <div class="step" id="step-1">
          <strong>Step 1:</strong> Check device fingerprint
        </div>
        <div class="step" id="step-2">
          <strong>Step 2:</strong> Register with Firebase
        </div>
        <div class="step" id="step-3">
          <strong>Step 3:</strong> Check for other browsers
        </div>
        <div class="step" id="step-4">
          <strong>Step 4:</strong> Perform auto-sync if needed
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <button class="btn btn--success" onclick="testAutoSync()">üöÄ Test Auto-Sync</button>
        <button class="btn" onclick="addTestData()">‚ûï Add Test Data</button>
        <button class="btn btn--danger" onclick="clearData()">üóëÔ∏è Clear Data</button>
      </div>
      
      <div id="auto-sync-results"></div>
    </div>

    <!-- Instructions -->
    <div class="test-box">
      <h3>üìã Test Instructions</h3>
      
      <ol>
        <li><strong>Browser A (e.g., Edge):</strong>
          <ul>
            <li>M·ªü trang n√†y</li>
            <li>Click "‚ûï Add Test Data" ƒë·ªÉ th√™m phim</li>
            <li>Click "üöÄ Test Auto-Sync" ƒë·ªÉ register</li>
          </ul>
        </li>
        <li><strong>Browser B (e.g., Chrome):</strong>
          <ul>
            <li>M·ªü trang n√†y tr√™n c√πng m√°y t√≠nh</li>
            <li>Click "üöÄ Test Auto-Sync"</li>
            <li>Ch·ªù 2-3 gi√¢y ƒë·ªÉ auto-sync</li>
            <li>Phim t·ª´ Browser A s·∫Ω xu·∫•t hi·ªán!</li>
          </ul>
        </li>
      </ol>
      
      <div style="background: #2a2a2a; padding: 15px; border-radius: 6px; margin-top: 15px;">
        <strong>Expected Result:</strong><br>
        - Browser A: 1 movie saved<br>
        - Browser B: 0 movies ‚Üí Auto-sync ‚Üí 1 movie (same as Browser A)<br>
        - Notification: "üöÄ ƒê√£ ƒë·ªìng b·ªô t·ª± ƒë·ªông t·ª´ [Browser A]"
      </div>
    </div>

    <!-- Debug Info -->
    <div class="test-box">
      <h3>üîß Debug Info</h3>
      
      <div class="info-display" id="debug-info">
        Debug information will appear here...
      </div>
      
      <button class="btn" onclick="showDebugInfo()">üîß Show Debug Info</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    function loadCurrentInfo() {
      try {
        if (!window.movieComments) {
          throw new Error('movieComments not available');
        }
        
        const userId = window.movieComments.getUserId();
        const userName = window.movieComments.getUserName();
        const browser = window.movieComments._getBrowserInfo ? window.movieComments._getBrowserInfo() : 'Unknown';
        const deviceId = window.movieComments._getSeamlessDeviceId ? window.movieComments._getSeamlessDeviceId() : 'N/A';
        
        document.getElementById('current-info').innerHTML = `
          <div><strong>Browser:</strong> ${browser}</div>
          <div><strong>Device ID:</strong> ${deviceId}</div>
          <div><strong>User ID:</strong> ${userId.substring(0, 30)}...</div>
          <div><strong>User Name:</strong> ${userName}</div>
          <div><strong>Firebase:</strong> ${window.movieComments.initialized ? '‚úÖ Connected' : '‚ùå Not Connected'}</div>
        `;
        
        document.getElementById('status-box').className = 'test-box success';
        
      } catch (error) {
        document.getElementById('current-info').innerHTML = `
          <div style="color: #e74c3c;">‚ùå Error: ${error.message}</div>
        `;
        document.getElementById('status-box').className = 'test-box error';
      }
    }
    
    async function testAutoSync() {
      const steps = [
        {
          id: 'step-1',
          name: 'Check device fingerprint',
          test: () => {
            if (!window.movieComments._getSeamlessDeviceId) {
              throw new Error('_getSeamlessDeviceId not available');
            }
            const deviceId = window.movieComments._getSeamlessDeviceId();
            return `Device ID: ${deviceId}`;
          }
        },
        {
          id: 'step-2',
          name: 'Register with Firebase',
          test: async () => {
            if (!window.movieComments._registerForSeamlessSync) {
              throw new Error('_registerForSeamlessSync not available');
            }
            const userId = window.movieComments.getUserId();
            await window.movieComments._registerForSeamlessSync(userId);
            return 'Registration successful';
          }
        },
        {
          id: 'step-3',
          name: 'Check for other browsers',
          test: async () => {
            if (!window.movieComments._checkSeamlessAutoSync) {
              throw new Error('_checkSeamlessAutoSync not available');
            }
            await window.movieComments._checkSeamlessAutoSync();
            return 'Check completed';
          }
        },
        {
          id: 'step-4',
          name: 'Perform auto-sync if needed',
          test: async () => {
            // Check current data
            const movies = await window.movieComments.getSavedMovies();
            return `Current movies: ${movies.length}`;
          }
        }
      ];
      
      for (const step of steps) {
        try {
          const result = await step.test();
          document.getElementById(step.id).className = 'step success';
          document.getElementById(step.id).innerHTML = `
            <strong>${step.name}:</strong> ‚úÖ ${result}
          `;
        } catch (error) {
          document.getElementById(step.id).className = 'step error';
          document.getElementById(step.id).innerHTML = `
            <strong>${step.name}:</strong> ‚ùå ${error.message}
          `;
        }
      }
      
      document.getElementById('auto-sync-results').innerHTML = `
        <div style="background: #2a2a2a; padding: 15px; border-radius: 6px; margin-top: 15px;">
          <strong>Auto-sync test completed!</strong><br>
          Check steps above for results. If all green, auto-sync should work.
        </div>
      `;
      
      document.getElementById('auto-sync-box').className = 'test-box success';
    }
    
    async function addTestData() {
      try {
        if (!window.movieComments) {
          throw new Error('movieComments not available');
        }
        
        const testMovie = {
          slug: `auto-sync-test-${Date.now()}`,
          name: `Auto-Sync Test ${new Date().toLocaleTimeString()}`,
          poster_url: 'https://via.placeholder.com/300x400',
          year: 2025,
          lang: 'Vietsub'
        };
        
        await window.movieComments.saveMovie(testMovie);
        
        document.getElementById('auto-sync-results').innerHTML = `
          <div style="background: #00b894; color: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
            ‚úÖ Test movie added: ${testMovie.name}<br>
            Now open this page in another browser to test auto-sync!
          </div>
        `;
        
      } catch (error) {
        document.getElementById('auto-sync-results').innerHTML = `
          <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
            ‚ùå Failed to add test data: ${error.message}
          </div>
        `;
      }
    }
    
    async function clearData() {
      try {
        if (!window.movieComments) {
          throw new Error('movieComments not available');
        }
        
        await window.movieComments.clearAllSavedMovies();
        
        document.getElementById('auto-sync-results').innerHTML = `
          <div style="background: #f39c12; color: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
            üóëÔ∏è All data cleared
          </div>
        `;
        
      } catch (error) {
        document.getElementById('auto-sync-results').innerHTML = `
          <div style="background: #e74c3c; color: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
            ‚ùå Failed to clear data: ${error.message}
          </div>
        `;
      }
    }
    
    function showDebugInfo() {
      const debugInfo = {
        'Window Location': window.location.href,
        'User Agent': navigator.userAgent.substring(0, 100) + '...',
        'Screen': `${screen.width}x${screen.height}`,
        'Language': navigator.language,
        'Timezone Offset': new Date().getTimezoneOffset(),
        'Hardware Concurrency': navigator.hardwareConcurrency || 'N/A',
        'Device Memory': navigator.deviceMemory || 'N/A',
        'Max Touch Points': navigator.maxTouchPoints || 0,
        'movieComments Available': !!window.movieComments,
        'Firebase Initialized': window.movieComments ? window.movieComments.initialized : false
      };
      
      let debugHtml = '<div><strong>Debug Information:</strong></div>';
      Object.entries(debugInfo).forEach(([key, value]) => {
        debugHtml += `<div><strong>${key}:</strong> ${value}</div>`;
      });
      
      document.getElementById('debug-info').innerHTML = debugHtml;
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        loadCurrentInfo();
        showDebugInfo();
      }, 1000);
    });
  </script>
</body>
</html>
