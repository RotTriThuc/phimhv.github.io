<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Firebase-Only Mode</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    .btn--warning { background: #f39c12; }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .status.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
    .status.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
    .status.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
    .status.warning { background: rgba(243, 156, 18, 0.2); border: 1px solid #f39c12; }
    
    .firebase-indicator {
      background: #00b894;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      margin: 15px 0;
      font-size: 16px;
    }
    
    .firebase-indicator.offline {
      background: #e74c3c;
    }
    
    .movie-list {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .movie-item {
      background: #333;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .refresh-demo {
      background: #2a2a2a;
      border: 2px solid #00b894;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
    }
    
    .keyboard-hint {
      background: #333;
      padding: 10px;
      border-radius: 6px;
      font-family: monospace;
      text-align: center;
      margin: 10px 0;
      border: 1px solid #555;
    }
    
    .log-area {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 250px;
      overflow-y: auto;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔥 Test Firebase-Only Mode</h1>
    <p>Test hệ thống chỉ dùng Firebase, không có localStorage fallback</p>
    
    <!-- Firebase Status -->
    <div class="test-section">
      <h3>📊 Firebase Status</h3>
      
      <div class="firebase-indicator" id="firebase-indicator">
        🔄 Checking Firebase connection...
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">
        <div style="text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #6c5ce7;" id="firebase-ready">❓</div>
          <div style="font-size: 12px; color: #888;">Firebase Ready</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #00b894;" id="user-count">0</div>
          <div style="font-size: 12px; color: #888;">Current User</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #e74c3c;" id="localStorage-status">❌</div>
          <div style="font-size: 12px; color: #888;">localStorage Disabled</div>
        </div>
      </div>
      
      <button class="btn" onclick="refreshFirebaseStatus()">🔄 Refresh Status</button>
    </div>

    <!-- Refresh Button Demo -->
    <div class="test-section">
      <h3>🔄 Refresh Button Demo</h3>
      <p>Test nút "Làm mới" Firebase và phím tắt F5</p>
      
      <div class="refresh-demo">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <div>
            <div style="font-weight: bold;">🔥 Đồng bộ Firebase • Test User</div>
            <div style="font-size: 12px; color: #888;">Phim được sync trên mọi thiết bị và trình duyệt</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn--success" onclick="testRefreshButton()" id="demo-refresh-btn">
              🔄 Làm mới
            </button>
            <button class="btn" onclick="testSyncButton()">
              📱 Sync thiết bị
            </button>
          </div>
        </div>
        
        <div class="keyboard-hint">
          💡 Nhấn <strong>F5</strong> để làm mới Firebase (chỉ hoạt động trong trang "Phim đã lưu")
        </div>
      </div>
      
      <div id="refresh-results"></div>
    </div>

    <!-- Firebase Operations Test -->
    <div class="test-section">
      <h3>🧪 Firebase Operations Test</h3>
      <p>Test các thao tác chỉ với Firebase (không localStorage)</p>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="btn btn--success" onclick="testSaveMovie()">💾 Save Movie</button>
        <button class="btn" onclick="testLoadMovies()">📚 Load Movies</button>
        <button class="btn btn--warning" onclick="testCheckMovie()">🔍 Check Movie</button>
        <button class="btn btn--danger" onclick="testRemoveMovie()">🗑️ Remove Movie</button>
      </div>
      
      <div class="movie-list" id="firebase-movies">
        <div style="color: #888; text-align: center; padding: 30px;">
          Chưa có phim nào
        </div>
      </div>
      
      <div id="operation-results"></div>
    </div>

    <!-- localStorage Verification -->
    <div class="test-section">
      <h3>🚫 localStorage Verification</h3>
      <p>Verify localStorage không được sử dụng</p>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="btn btn--warning" onclick="checkLocalStorage()">🔍 Check localStorage</button>
        <button class="btn btn--danger" onclick="addFakeLocalData()">➕ Add Fake Local Data</button>
        <button class="btn" onclick="testWithFakeData()">🧪 Test With Fake Data</button>
      </div>
      
      <div id="localStorage-results"></div>
    </div>

    <!-- Debug Log -->
    <div class="test-section">
      <h3>📝 Debug Log</h3>
      <div class="log-area" id="debug-log">
        Debug messages will appear here...
      </div>
      <button class="btn" onclick="clearDebugLog()">🗑️ Clear Log</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    let debugMessages = [];
    let testMovieSlug = null;
    
    // Capture console
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function captureConsole() {
      ['log', 'error', 'warn'].forEach(method => {
        console[method] = function(...args) {
          const message = args.join(' ');
          debugMessages.push(`[${method.toUpperCase()}] ${message}`);
          updateDebugLog();
          originalConsole[method].apply(console, args);
        };
      });
    }
    
    function updateDebugLog() {
      const debugLog = document.getElementById('debug-log');
      const recent = debugMessages.slice(-20);
      debugLog.innerHTML = recent.map(msg => `<div>${msg}</div>`).join('');
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    function clearDebugLog() {
      debugMessages = [];
      updateDebugLog();
    }
    
    function addDebugMessage(message) {
      debugMessages.push(`[TEST] ${message}`);
      updateDebugLog();
    }
    
    function refreshFirebaseStatus() {
      // Check Firebase status
      const isFirebaseReady = window.movieComments?.initialized || false;
      const userName = window.movieComments?.getUserName() || 'Unknown';
      
      // Update indicators
      document.getElementById('firebase-ready').textContent = isFirebaseReady ? '✅' : '❌';
      document.getElementById('user-count').textContent = userName.charAt(0).toUpperCase();
      document.getElementById('localStorage-status').textContent = '🚫'; // Always disabled
      
      // Update main indicator
      const indicator = document.getElementById('firebase-indicator');
      if (isFirebaseReady) {
        indicator.textContent = '🔥 Firebase Connected - Firebase-Only Mode Active';
        indicator.className = 'firebase-indicator';
      } else {
        indicator.textContent = '⚠️ Firebase Connecting... - No localStorage Fallback';
        indicator.className = 'firebase-indicator offline';
      }
      
      addDebugMessage(`📊 Firebase status: ${isFirebaseReady ? 'Ready' : 'Not Ready'}, User: ${userName}`);
    }
    
    async function testRefreshButton() {
      const btn = document.getElementById('demo-refresh-btn');
      btn.disabled = true;
      btn.textContent = '⏳ Đang tải...';
      
      try {
        addDebugMessage('🔄 Testing refresh button...');
        
        // Simulate refresh operation
        if (window.Storage) {
          window.Storage._savedMoviesCache = null;
          window.Storage._lastCacheUpdate = 0;
        }
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        document.getElementById('refresh-results').innerHTML = `
          <div class="status success">
            ✅ Refresh button test successful!<br>
            Cache cleared, Firebase data refreshed
          </div>
        `;
        
        addDebugMessage('✅ Refresh button test completed');
        
      } catch (error) {
        document.getElementById('refresh-results').innerHTML = `
          <div class="status error">❌ Refresh test failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ Refresh test error: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = '🔄 Làm mới';
      }
    }
    
    function testSyncButton() {
      addDebugMessage('📱 Testing sync button...');
      
      if (window.showCrossDeviceSync) {
        window.showCrossDeviceSync();
        addDebugMessage('✅ Sync dialog opened');
      } else {
        addDebugMessage('❌ Sync function not available');
      }
    }
    
    async function testSaveMovie() {
      try {
        testMovieSlug = 'firebase-test-' + Date.now();
        const testMovie = {
          slug: testMovieSlug,
          name: 'Firebase Test Movie ' + new Date().toLocaleTimeString(),
          poster_url: 'https://via.placeholder.com/300x400',
          year: 2025,
          lang: 'Vietsub'
        };
        
        addDebugMessage(`💾 Saving movie: ${testMovie.name}`);
        
        if (window.Storage) {
          await window.Storage.saveMovie(testMovie);
          
          document.getElementById('operation-results').innerHTML = `
            <div class="status success">✅ Movie saved to Firebase: ${testMovie.name}</div>
          `;
          
          addDebugMessage(`✅ Movie saved successfully: ${testMovieSlug}`);
          testLoadMovies(); // Refresh list
        } else {
          throw new Error('Storage not available');
        }
        
      } catch (error) {
        document.getElementById('operation-results').innerHTML = `
          <div class="status error">❌ Save failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ Save movie error: ${error.message}`);
      }
    }
    
    async function testLoadMovies() {
      try {
        addDebugMessage('📚 Loading movies from Firebase...');
        
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          
          const container = document.getElementById('firebase-movies');
          if (movies.length === 0) {
            container.innerHTML = '<div style="color: #888; text-align: center; padding: 30px;">Chưa có phim nào</div>';
          } else {
            container.innerHTML = movies.map(movie => `
              <div class="movie-item">
                <div>
                  <div style="font-weight: bold;">🎬 ${movie.name || movie.slug}</div>
                  <div style="font-size: 12px; color: #888;">Saved: ${new Date(movie.savedAt).toLocaleString()}</div>
                </div>
                <button class="btn btn--danger" onclick="removeMovie('${movie.slug}')" style="padding: 4px 8px; font-size: 12px;">🗑️</button>
              </div>
            `).join('');
          }
          
          document.getElementById('operation-results').innerHTML = `
            <div class="status success">✅ Loaded ${movies.length} movies from Firebase</div>
          `;
          
          addDebugMessage(`📚 Loaded ${movies.length} movies from Firebase`);
        }
        
      } catch (error) {
        document.getElementById('operation-results').innerHTML = `
          <div class="status error">❌ Load failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ Load movies error: ${error.message}`);
      }
    }
    
    async function testCheckMovie() {
      try {
        if (!testMovieSlug) {
          throw new Error('No test movie to check. Save a movie first.');
        }
        
        addDebugMessage(`🔍 Checking if movie exists: ${testMovieSlug}`);
        
        if (window.Storage) {
          const exists = await window.Storage.isMovieSaved(testMovieSlug);
          
          document.getElementById('operation-results').innerHTML = `
            <div class="status ${exists ? 'success' : 'warning'}">
              ${exists ? '✅' : '⚠️'} Movie ${testMovieSlug} ${exists ? 'exists' : 'not found'} in Firebase
            </div>
          `;
          
          addDebugMessage(`🔍 Movie check result: ${exists}`);
        }
        
      } catch (error) {
        document.getElementById('operation-results').innerHTML = `
          <div class="status error">❌ Check failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ Check movie error: ${error.message}`);
      }
    }
    
    async function testRemoveMovie() {
      try {
        if (!testMovieSlug) {
          throw new Error('No test movie to remove. Save a movie first.');
        }
        
        addDebugMessage(`🗑️ Removing movie: ${testMovieSlug}`);
        
        if (window.Storage) {
          await window.Storage.removeSavedMovie(testMovieSlug);
          
          document.getElementById('operation-results').innerHTML = `
            <div class="status success">✅ Movie removed from Firebase: ${testMovieSlug}</div>
          `;
          
          addDebugMessage(`✅ Movie removed successfully: ${testMovieSlug}`);
          testMovieSlug = null;
          testLoadMovies(); // Refresh list
        }
        
      } catch (error) {
        document.getElementById('operation-results').innerHTML = `
          <div class="status error">❌ Remove failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ Remove movie error: ${error.message}`);
      }
    }
    
    async function removeMovie(slug) {
      try {
        if (window.Storage) {
          await window.Storage.removeSavedMovie(slug);
          addDebugMessage(`🗑️ Removed movie: ${slug}`);
          testLoadMovies(); // Refresh list
        }
      } catch (error) {
        addDebugMessage(`❌ Remove error: ${error.message}`);
      }
    }
    
    function checkLocalStorage() {
      const savedMovies = localStorage.getItem('savedMovies');
      const watchProgress = localStorage.getItem('watchProgress');
      
      document.getElementById('localStorage-results').innerHTML = `
        <div class="status info">
          <strong>localStorage Check:</strong><br>
          savedMovies: ${savedMovies ? `${JSON.parse(savedMovies).length} items` : 'null'}<br>
          watchProgress: ${watchProgress ? 'exists' : 'null'}<br>
          <strong>Status:</strong> ${!savedMovies && !watchProgress ? '✅ Clean (Firebase-only)' : '⚠️ Has data (should be ignored)'}
        </div>
      `;
      
      addDebugMessage(`🔍 localStorage check - savedMovies: ${!!savedMovies}, watchProgress: ${!!watchProgress}`);
    }
    
    function addFakeLocalData() {
      const fakeMovies = [
        { slug: 'fake-movie-1', name: 'Fake Movie 1', savedAt: Date.now() },
        { slug: 'fake-movie-2', name: 'Fake Movie 2', savedAt: Date.now() }
      ];
      
      localStorage.setItem('savedMovies', JSON.stringify(fakeMovies));
      
      document.getElementById('localStorage-results').innerHTML = `
        <div class="status warning">
          ⚠️ Added fake localStorage data (2 movies)<br>
          This should be ignored by Firebase-only system
        </div>
      `;
      
      addDebugMessage('➕ Added fake localStorage data for testing');
    }
    
    async function testWithFakeData() {
      try {
        addDebugMessage('🧪 Testing with fake localStorage data...');
        
        // Check if system ignores localStorage
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          
          const localMovies = JSON.parse(localStorage.getItem('savedMovies') || '[]');
          
          document.getElementById('localStorage-results').innerHTML = `
            <div class="status ${movies.length === localMovies.length ? 'error' : 'success'}">
              <strong>🧪 Fake Data Test:</strong><br>
              localStorage has: ${localMovies.length} movies<br>
              Firebase returned: ${movies.length} movies<br>
              <strong>Result:</strong> ${movies.length === localMovies.length ? '❌ Using localStorage (BAD)' : '✅ Ignoring localStorage (GOOD)'}
            </div>
          `;
          
          addDebugMessage(`🧪 Fake data test - localStorage: ${localMovies.length}, Firebase: ${movies.length}`);
        }
        
      } catch (error) {
        addDebugMessage(`❌ Fake data test error: ${error.message}`);
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      captureConsole();
      
      // Initial status check
      setTimeout(() => {
        refreshFirebaseStatus();
        addDebugMessage('🚀 Firebase-only test system initialized');
      }, 2000);
      
      // Auto-refresh status every 10 seconds
      setInterval(() => {
        refreshFirebaseStatus();
      }, 10000);
      
      // Test F5 key
      document.addEventListener('keydown', (event) => {
        if (event.key === 'F5') {
          addDebugMessage('⌨️ F5 key pressed - would trigger Firebase refresh in saved movies page');
        }
      });
    });
  </script>
</body>
</html>
