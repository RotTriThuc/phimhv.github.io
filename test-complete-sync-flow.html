<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Complete Sync Flow</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .device-simulator {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .device {
      background: #2a2a2a;
      border: 2px solid #444;
      border-radius: 12px;
      padding: 20px;
      position: relative;
    }
    
    .device-header {
      background: #333;
      margin: -20px -20px 15px -20px;
      padding: 10px 20px;
      border-radius: 10px 10px 0 0;
      font-weight: bold;
      text-align: center;
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 3px;
      font-size: 13px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    .btn--small { padding: 4px 8px; font-size: 11px; }
    
    .status {
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 13px;
    }
    
    .status.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
    .status.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
    .status.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
    
    .movie-list {
      background: #1a1a1a;
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
      min-height: 80px;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .movie-item {
      background: #333;
      padding: 6px 10px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .sync-code-display {
      background: #6c5ce7;
      color: white;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      letter-spacing: 2px;
      margin: 10px 0;
    }
    
    .sync-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: #fff;
      text-align: center;
      font-size: 16px;
      letter-spacing: 2px;
      margin: 8px 0;
    }
    
    .log-area {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Test Complete Sync Flow</h1>
    <p>Test to√†n b·ªô qu√° tr√¨nh sync t·ª´ A ƒë·∫øn Z</p>
    
    <!-- Step-by-Step Guide -->
    <div class="test-section">
      <h3>üìã Step-by-Step Test Guide</h3>
      <div style="background: #2a2a2a; padding: 15px; border-radius: 8px;">
        <div style="margin-bottom: 10px;"><strong>üéØ M·ª•c ti√™u:</strong> Test sync phim t·ª´ Device A sang Device B</div>
        <div style="font-size: 13px; color: #888;">
          <div>1. Device A: L∆∞u m·ªôt v√†i phim test</div>
          <div>2. Device A: T·∫°o sync code</div>
          <div>3. Device B: Nh·∫≠p sync code</div>
          <div>4. Device B: Verify phim xu·∫•t hi·ªán</div>
        </div>
      </div>
    </div>

    <!-- Device Simulator -->
    <div class="test-section">
      <h3>üì± Device Simulator</h3>
      
      <div class="device-simulator">
        <!-- Device A -->
        <div class="device">
          <div class="device-header">üåê Device A (Opera)</div>
          
          <div style="margin-bottom: 10px;">
            <strong>User:</strong> <span id="device-a-user">Loading...</span><br>
            <strong>User ID:</strong> <span id="device-a-id" style="font-size: 10px; color: #888;">Loading...</span>
          </div>
          
          <div class="movie-list" id="device-a-movies">
            <div style="color: #888; text-align: center; padding: 20px; font-size: 12px;">
              Ch∆∞a c√≥ phim n√†o
            </div>
          </div>
          
          <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
            <button class="btn btn--small" onclick="addTestMovieA()">‚ûï Add Movie</button>
            <button class="btn btn--small" onclick="loadMoviesA()">üìö Load Movies</button>
            <button class="btn btn--small" onclick="clearMoviesA()">üóëÔ∏è Clear</button>
          </div>
          
          <button class="btn btn--success" onclick="generateSyncCodeA()" style="width: 100%; margin-bottom: 10px;">
            üì§ Generate Sync Code
          </button>
          
          <div id="sync-code-container-a" style="display: none;">
            <div class="sync-code-display" id="sync-code-a">123456</div>
            <div style="text-align: center; font-size: 11px; color: #888;">
              Nh·∫≠p m√£ n√†y v√†o Device B
            </div>
          </div>
        </div>

        <!-- Device B -->
        <div class="device">
          <div class="device-header">üî∑ Device B (Edge)</div>
          
          <div style="margin-bottom: 10px;">
            <strong>User:</strong> <span id="device-b-user">Loading...</span><br>
            <strong>User ID:</strong> <span id="device-b-id" style="font-size: 10px; color: #888;">Loading...</span>
          </div>
          
          <div class="movie-list" id="device-b-movies">
            <div style="color: #888; text-align: center; padding: 20px; font-size: 12px;">
              Ch∆∞a c√≥ phim n√†o
            </div>
          </div>
          
          <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
            <button class="btn btn--small" onclick="loadMoviesB()">üìö Load Movies</button>
            <button class="btn btn--small" onclick="clearCacheB()">üóëÔ∏è Clear Cache</button>
            <button class="btn btn--small" onclick="refreshUserB()">üîÑ Refresh User</button>
          </div>
          
          <input type="text" class="sync-input" id="sync-input-b" placeholder="Nh·∫≠p m√£ sync" maxlength="6">
          <button class="btn btn--success" onclick="applySyncCodeB()" style="width: 100%;">
            üì• Apply Sync Code
          </button>
          
          <div id="sync-result-b" style="margin-top: 10px;"></div>
        </div>
      </div>
    </div>

    <!-- Real System Test -->
    <div class="test-section">
      <h3>üß™ Real System Test</h3>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="btn" onclick="testRealSaveMovie()">üíæ Save Real Movie</button>
        <button class="btn" onclick="testRealLoadMovies()">üìö Load Real Movies</button>
        <button class="btn" onclick="testRealGenerateCode()">üì§ Real Generate Code</button>
        <button class="btn" onclick="testRealApplyCode()">üì• Real Apply Code</button>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <strong>Real Sync Code:</strong>
          <div id="real-sync-code" style="background: #333; padding: 10px; border-radius: 4px; text-align: center; font-size: 18px; font-weight: bold; margin: 5px 0;">
            -
          </div>
        </div>
        <div>
          <strong>Apply Real Code:</strong>
          <input type="text" id="real-sync-input" placeholder="Enter code" maxlength="6" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #555; background: #333; color: #fff; text-align: center;">
        </div>
      </div>
      
      <div id="real-test-results"></div>
    </div>

    <!-- Debug Log -->
    <div class="test-section">
      <h3>üìù Debug Log</h3>
      <div class="log-area" id="debug-log">
        Debug messages will appear here...
      </div>
      <button class="btn btn--small" onclick="clearDebugLog()">üóëÔ∏è Clear Log</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    let debugMessages = [];
    let deviceAMovies = [];
    let deviceBMovies = [];
    let currentSyncCode = null;
    
    // Capture console for debug
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function captureConsole() {
      ['log', 'error', 'warn'].forEach(method => {
        console[method] = function(...args) {
          const message = args.join(' ');
          debugMessages.push(`[${method.toUpperCase()}] ${message}`);
          updateDebugLog();
          originalConsole[method].apply(console, args);
        };
      });
    }
    
    function updateDebugLog() {
      const debugLog = document.getElementById('debug-log');
      const recent = debugMessages.slice(-15);
      debugLog.innerHTML = recent.map(msg => `<div>${msg}</div>`).join('');
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    function clearDebugLog() {
      debugMessages = [];
      updateDebugLog();
    }
    
    function addDebugMessage(message) {
      debugMessages.push(`[TEST] ${message}`);
      updateDebugLog();
    }
    
    // Device A functions
    function updateDeviceAInfo() {
      if (window.movieComments) {
        const userId = window.movieComments.getUserId();
        const userName = window.movieComments.getUserName();
        
        document.getElementById('device-a-user').textContent = userName;
        document.getElementById('device-a-id').textContent = userId.substring(0, 20) + '...';
      }
    }
    
    async function addTestMovieA() {
      const movieNames = [
        'Thanh G∆∞∆°m Di·ªát Qu·ª∑',
        'Attack on Titan', 
        'One Piece',
        'Naruto Shippuden',
        'Dragon Ball Super',
        'Demon Slayer Movie',
        'Your Name',
        'Spirited Away'
      ];
      
      const randomMovie = movieNames[Math.floor(Math.random() * movieNames.length)];
      
      try {
        if (window.Storage) {
          const testMovie = {
            slug: 'test-' + randomMovie.toLowerCase().replace(/\s+/g, '-'),
            name: randomMovie,
            poster_url: 'https://via.placeholder.com/300x400',
            year: 2025,
            lang: 'Vietsub'
          };
          
          await window.Storage.saveMovie(testMovie);
          addDebugMessage(`‚úÖ Device A: Saved "${randomMovie}"`);
          loadMoviesA();
        }
      } catch (error) {
        addDebugMessage(`‚ùå Device A: Error saving movie - ${error.message}`);
      }
    }
    
    async function loadMoviesA() {
      try {
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          deviceAMovies = movies;
          
          const container = document.getElementById('device-a-movies');
          if (movies.length === 0) {
            container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px; font-size: 12px;">Ch∆∞a c√≥ phim n√†o</div>';
          } else {
            container.innerHTML = movies.map(movie => 
              `<div class="movie-item">üé¨ ${movie.name || movie.slug}</div>`
            ).join('');
          }
          
          addDebugMessage(`üìö Device A: Loaded ${movies.length} movies`);
        }
      } catch (error) {
        addDebugMessage(`‚ùå Device A: Error loading movies - ${error.message}`);
      }
    }
    
    async function clearMoviesA() {
      try {
        if (window.Storage) {
          await window.Storage.clearAllSavedMovies();
          addDebugMessage('üóëÔ∏è Device A: Cleared all movies');
          loadMoviesA();
        }
      } catch (error) {
        addDebugMessage(`‚ùå Device A: Error clearing movies - ${error.message}`);
      }
    }
    
    function generateSyncCodeA() {
      try {
        if (window.movieComments && window.movieComments.generateSyncCode) {
          currentSyncCode = window.movieComments.generateSyncCode();
          document.getElementById('sync-code-a').textContent = currentSyncCode;
          document.getElementById('sync-code-container-a').style.display = 'block';
          addDebugMessage(`üîë Device A: Generated sync code - ${currentSyncCode}`);
        } else {
          addDebugMessage('‚ùå Device A: generateSyncCode not available');
        }
      } catch (error) {
        addDebugMessage(`‚ùå Device A: Error generating sync code - ${error.message}`);
      }
    }
    
    // Device B functions
    function updateDeviceBInfo() {
      if (window.movieComments) {
        const userId = window.movieComments.getUserId();
        const userName = window.movieComments.getUserName();
        
        document.getElementById('device-b-user').textContent = userName;
        document.getElementById('device-b-id').textContent = userId.substring(0, 20) + '...';
      }
    }
    
    async function loadMoviesB() {
      try {
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          deviceBMovies = movies;
          
          const container = document.getElementById('device-b-movies');
          if (movies.length === 0) {
            container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px; font-size: 12px;">Ch∆∞a c√≥ phim n√†o</div>';
          } else {
            container.innerHTML = movies.map(movie => 
              `<div class="movie-item">üé¨ ${movie.name || movie.slug}</div>`
            ).join('');
          }
          
          addDebugMessage(`üìö Device B: Loaded ${movies.length} movies`);
        }
      } catch (error) {
        addDebugMessage(`‚ùå Device B: Error loading movies - ${error.message}`);
      }
    }
    
    function clearCacheB() {
      if (window.Storage) {
        window.Storage._savedMoviesCache = null;
      }
      localStorage.removeItem('savedMovies');
      addDebugMessage('üóëÔ∏è Device B: Cleared cache');
      loadMoviesB();
    }
    
    function refreshUserB() {
      updateDeviceBInfo();
      loadMoviesB();
      addDebugMessage('üîÑ Device B: Refreshed user info');
    }
    
    async function applySyncCodeB() {
      const syncCode = document.getElementById('sync-input-b').value.trim();
      if (!syncCode) {
        addDebugMessage('‚ùå Device B: No sync code entered');
        return;
      }
      
      try {
        addDebugMessage(`üîÑ Device B: Applying sync code - ${syncCode}`);
        
        // Log before sync
        const beforeUserId = window.movieComments?.getUserId();
        const beforeMovies = await window.Storage?.getSavedMovies() || [];
        addDebugMessage(`üìä Device B: Before sync - User: ${beforeUserId}, Movies: ${beforeMovies.length}`);
        
        if (window.movieComments && window.movieComments.useSyncCode) {
          const result = await window.movieComments.useSyncCode(syncCode);
          
          // Log after sync
          const afterUserId = window.movieComments.getUserId();
          const afterMovies = await window.Storage.getSavedMovies();
          addDebugMessage(`üìä Device B: After sync - User: ${afterUserId}, Movies: ${afterMovies.length}`);
          
          document.getElementById('sync-result-b').innerHTML = `
            <div class="status success">
              ‚úÖ Sync th√†nh c√¥ng!<br>
              User: ${result.userName}<br>
              Movies: ${afterMovies.length}
            </div>
          `;
          
          // Update displays
          updateDeviceBInfo();
          loadMoviesB();
          
          addDebugMessage(`‚úÖ Device B: Sync successful with ${result.userName}`);
          
        } else {
          addDebugMessage('‚ùå Device B: useSyncCode not available');
        }
      } catch (error) {
        document.getElementById('sync-result-b').innerHTML = `
          <div class="status error">
            ‚ùå Sync th·∫•t b·∫°i!<br>
            Error: ${error.message}
          </div>
        `;
        addDebugMessage(`‚ùå Device B: Sync failed - ${error.message}`);
      }
    }
    
    // Real system tests
    async function testRealSaveMovie() {
      try {
        const testMovie = {
          slug: 'real-test-movie-' + Date.now(),
          name: 'Real Test Movie ' + new Date().toLocaleTimeString(),
          poster_url: 'https://via.placeholder.com/300x400',
          year: 2025,
          lang: 'Vietsub'
        };
        
        if (window.Storage) {
          await window.Storage.saveMovie(testMovie);
          addDebugMessage(`üíæ Real: Saved "${testMovie.name}"`);
          
          document.getElementById('real-test-results').innerHTML = `
            <div class="status success">‚úÖ Saved: ${testMovie.name}</div>
          `;
        }
      } catch (error) {
        addDebugMessage(`‚ùå Real: Save error - ${error.message}`);
      }
    }
    
    async function testRealLoadMovies() {
      try {
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          addDebugMessage(`üìö Real: Loaded ${movies.length} movies`);
          
          document.getElementById('real-test-results').innerHTML = `
            <div class="status info">üìö Found ${movies.length} movies</div>
          `;
        }
      } catch (error) {
        addDebugMessage(`‚ùå Real: Load error - ${error.message}`);
      }
    }
    
    function testRealGenerateCode() {
      try {
        if (window.movieComments && window.movieComments.generateSyncCode) {
          const code = window.movieComments.generateSyncCode();
          document.getElementById('real-sync-code').textContent = code;
          addDebugMessage(`üîë Real: Generated code - ${code}`);
        } else {
          addDebugMessage('‚ùå Real: generateSyncCode not available');
        }
      } catch (error) {
        addDebugMessage(`‚ùå Real: Generate error - ${error.message}`);
      }
    }
    
    async function testRealApplyCode() {
      const syncCode = document.getElementById('real-sync-input').value.trim();
      if (!syncCode) {
        addDebugMessage('‚ùå Real: No sync code entered');
        return;
      }
      
      try {
        if (window.movieComments && window.movieComments.useSyncCode) {
          const result = await window.movieComments.useSyncCode(syncCode);
          addDebugMessage(`‚úÖ Real: Sync successful with ${result.userName}`);
          
          document.getElementById('real-test-results').innerHTML = `
            <div class="status success">‚úÖ Synced with: ${result.userName}</div>
          `;
        } else {
          addDebugMessage('‚ùå Real: useSyncCode not available');
        }
      } catch (error) {
        addDebugMessage(`‚ùå Real: Apply error - ${error.message}`);
        
        document.getElementById('real-test-results').innerHTML = `
          <div class="status error">‚ùå Error: ${error.message}</div>
        `;
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      captureConsole();
      
      // Initial setup
      setTimeout(() => {
        updateDeviceAInfo();
        updateDeviceBInfo();
        loadMoviesA();
        loadMoviesB();
        addDebugMessage('üöÄ Test system initialized');
      }, 2000);
      
      // Auto-refresh every 10 seconds
      setInterval(() => {
        updateDeviceAInfo();
        updateDeviceBInfo();
      }, 10000);
    });
    
    // Auto-format sync inputs
    document.getElementById('sync-input-b').oninput = (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    };
    
    document.getElementById('real-sync-input').oninput = (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    };
  </script>
</body>
</html>
