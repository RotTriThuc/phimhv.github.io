<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Single Refresh Button</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .status.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
    .status.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
    .status.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
    
    .button-preview {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
    }
    
    .button-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #333;
      border-radius: 6px;
    }
    
    .log-area {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔍 Test Single Refresh Button</h1>
    <p>Verify chỉ còn 1 nút "Làm mới" trong trang "Phim đã lưu"</p>
    
    <!-- Button Count Test -->
    <div class="test-section">
      <h3>🔢 Button Count Test</h3>
      <p>Kiểm tra số lượng nút "Làm mới" trên trang</p>
      
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button class="btn btn--success" onclick="countRefreshButtons()">🔍 Count Refresh Buttons</button>
        <button class="btn" onclick="navigateToSavedMovies()">📺 Go to Saved Movies</button>
        <button class="btn" onclick="inspectButtonElements()">🔍 Inspect Elements</button>
      </div>
      
      <div id="button-count-results"></div>
    </div>

    <!-- Button Layout Preview -->
    <div class="test-section">
      <h3>🎨 Expected Button Layout</h3>
      <p>Đây là layout mong muốn sau khi xóa duplicate button</p>
      
      <div class="button-preview">
        <h4>📊 Sync Status Section (TOP)</h4>
        <div class="button-row">
          <span>🔄 Đồng bộ Firebase • User Name</span>
          <div style="margin-left: auto; display: flex; gap: 8px;">
            <button class="btn btn--success" style="font-size: 12px; padding: 6px 12px;">🔄 Làm mới</button>
            <button class="btn" style="font-size: 12px; padding: 6px 12px;">📱 Sync thiết bị</button>
          </div>
        </div>
        
        <h4 style="margin-top: 20px;">⚙️ Actions Section (BOTTOM)</h4>
        <div class="button-row">
          <button class="btn btn--danger">🗑️ Xóa tất cả</button>
          <button class="btn">📤 Xuất danh sách</button>
          <span style="color: #888; font-style: italic;">❌ Nút "Làm mới" đã bị xóa</span>
        </div>
      </div>
    </div>

    <!-- Real Page Test -->
    <div class="test-section">
      <h3>🧪 Real Page Test</h3>
      <p>Test trực tiếp trên trang "Phim đã lưu"</p>
      
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button class="btn" onclick="testRealPage()">🎬 Test Real Saved Movies Page</button>
        <button class="btn" onclick="testButtonFunctionality()">🔄 Test Button Functionality</button>
        <button class="btn" onclick="testF5Shortcut()">⌨️ Test F5 Shortcut</button>
      </div>
      
      <div id="real-page-results"></div>
    </div>

    <!-- Debug Log -->
    <div class="test-section">
      <h3>📝 Debug Log</h3>
      <div class="log-area" id="debug-log">
        Debug messages will appear here...
      </div>
      <button class="btn" onclick="clearDebugLog()">🗑️ Clear Log</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    let debugMessages = [];
    
    // Capture console
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function captureConsole() {
      ['log', 'error', 'warn'].forEach(method => {
        console[method] = function(...args) {
          const message = args.join(' ');
          debugMessages.push(`[${method.toUpperCase()}] ${message}`);
          updateDebugLog();
          originalConsole[method].apply(console, args);
        };
      });
    }
    
    function updateDebugLog() {
      const debugLog = document.getElementById('debug-log');
      const recent = debugMessages.slice(-15);
      debugLog.innerHTML = recent.map(msg => `<div>${msg}</div>`).join('');
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    function clearDebugLog() {
      debugMessages = [];
      updateDebugLog();
    }
    
    function addDebugMessage(message) {
      debugMessages.push(`[TEST] ${message}`);
      updateDebugLog();
    }
    
    function countRefreshButtons() {
      // Count all buttons with "Làm mới" text
      const allButtons = document.querySelectorAll('button');
      const refreshButtons = Array.from(allButtons).filter(btn => 
        btn.textContent.includes('Làm mới') || btn.textContent.includes('🔄')
      );
      
      // Count specific classes
      const refreshFirebaseBtn = document.querySelectorAll('.refresh-firebase-btn');
      const syncBtn = document.querySelectorAll('button').length > 0 ? 
        Array.from(document.querySelectorAll('button')).filter(btn => 
          btn.textContent.includes('🔄 Làm mới')
        ) : [];
      
      const result = `
        <div class="status ${refreshButtons.length === 1 ? 'success' : 'error'}">
          <strong>🔢 Button Count Results:</strong><br>
          Total "Làm mới" buttons: ${refreshButtons.length}<br>
          .refresh-firebase-btn: ${refreshFirebaseBtn.length}<br>
          Text "🔄 Làm mới": ${syncBtn.length}<br>
          <strong>Status:</strong> ${refreshButtons.length === 1 ? '✅ CORRECT (1 button)' : '❌ WRONG (should be 1)'}
        </div>
      `;
      
      document.getElementById('button-count-results').innerHTML = result;
      
      addDebugMessage(`🔢 Refresh button count: ${refreshButtons.length}`);
      
      // Log button details
      refreshButtons.forEach((btn, index) => {
        addDebugMessage(`Button ${index + 1}: "${btn.textContent.trim()}" (class: ${btn.className})`);
      });
    }
    
    function navigateToSavedMovies() {
      addDebugMessage('📺 Navigating to saved movies page...');
      window.location.hash = '#/phim-da-luu';
      
      setTimeout(() => {
        countRefreshButtons();
        addDebugMessage('✅ Navigation completed, counted buttons');
      }, 2000);
    }
    
    function inspectButtonElements() {
      const elements = {
        'All buttons': document.querySelectorAll('button').length,
        'refresh-firebase-btn': document.querySelectorAll('.refresh-firebase-btn').length,
        'sync-device-btn': document.querySelectorAll('.sync-device-btn').length,
        'btn--ghost': document.querySelectorAll('.btn--ghost').length,
        'Actions section': document.querySelectorAll('.actions, [class*="action"]').length
      };
      
      let result = '<div class="status info"><strong>🔍 Element Inspection:</strong><br>';
      Object.entries(elements).forEach(([name, count]) => {
        result += `${name}: ${count}<br>`;
      });
      result += '</div>';
      
      document.getElementById('button-count-results').innerHTML = result;
      
      addDebugMessage('🔍 Element inspection completed');
      Object.entries(elements).forEach(([name, count]) => {
        addDebugMessage(`${name}: ${count}`);
      });
    }
    
    async function testRealPage() {
      try {
        addDebugMessage('🎬 Testing real saved movies page...');
        
        // Navigate to saved movies page
        window.location.hash = '#/phim-da-luu';
        
        // Wait for page to load
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        // Count buttons
        const refreshButtons = Array.from(document.querySelectorAll('button')).filter(btn => 
          btn.textContent.includes('Làm mới')
        );
        
        // Check layout
        const syncStatus = document.querySelector('[class*="sync"], [style*="sync"]');
        const actions = document.querySelector('.actions, [class*="action"]');
        
        const result = `
          <div class="status ${refreshButtons.length === 1 ? 'success' : 'error'}">
            <strong>🎬 Real Page Test:</strong><br>
            Current hash: ${window.location.hash}<br>
            Refresh buttons found: ${refreshButtons.length}<br>
            Sync status section: ${syncStatus ? 'Found' : 'Not found'}<br>
            Actions section: ${actions ? 'Found' : 'Not found'}<br>
            <strong>Result:</strong> ${refreshButtons.length === 1 ? '✅ SUCCESS' : '❌ FAILED'}
          </div>
        `;
        
        document.getElementById('real-page-results').innerHTML = result;
        addDebugMessage(`🎬 Real page test - Found ${refreshButtons.length} refresh buttons`);
        
      } catch (error) {
        document.getElementById('real-page-results').innerHTML = `
          <div class="status error">❌ Real page test failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ Real page test error: ${error.message}`);
      }
    }
    
    function testButtonFunctionality() {
      try {
        addDebugMessage('🔄 Testing button functionality...');
        
        const refreshBtn = document.querySelector('.refresh-firebase-btn');
        if (refreshBtn) {
          // Test click
          refreshBtn.click();
          
          document.getElementById('real-page-results').innerHTML = `
            <div class="status success">
              ✅ Button functionality test passed<br>
              Found refresh button and clicked successfully
            </div>
          `;
          
          addDebugMessage('✅ Button click test successful');
        } else {
          document.getElementById('real-page-results').innerHTML = `
            <div class="status error">❌ Refresh button not found</div>
          `;
          addDebugMessage('❌ Refresh button not found');
        }
        
      } catch (error) {
        document.getElementById('real-page-results').innerHTML = `
          <div class="status error">❌ Button test failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ Button test error: ${error.message}`);
      }
    }
    
    function testF5Shortcut() {
      try {
        addDebugMessage('⌨️ Testing F5 shortcut...');
        
        // Simulate F5 key press
        const event = new KeyboardEvent('keydown', {
          key: 'F5',
          code: 'F5',
          keyCode: 116,
          which: 116,
          bubbles: true
        });
        
        document.dispatchEvent(event);
        
        document.getElementById('real-page-results').innerHTML = `
          <div class="status info">
            ⌨️ F5 shortcut test completed<br>
            Check console for F5 handling messages
          </div>
        `;
        
        addDebugMessage('⌨️ F5 key event dispatched');
        
      } catch (error) {
        document.getElementById('real-page-results').innerHTML = `
          <div class="status error">❌ F5 test failed: ${error.message}</div>
        `;
        addDebugMessage(`❌ F5 test error: ${error.message}`);
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      captureConsole();
      
      // Initial button count
      setTimeout(() => {
        countRefreshButtons();
        addDebugMessage('🚀 Single refresh button test initialized');
      }, 1000);
      
      // Auto-check every 5 seconds
      setInterval(() => {
        if (window.location.hash === '#/phim-da-luu') {
          countRefreshButtons();
        }
      }, 5000);
    });
    
    // Monitor hash changes
    window.addEventListener('hashchange', () => {
      addDebugMessage(`📍 Hash changed to: ${window.location.hash}`);
      if (window.location.hash === '#/phim-da-luu') {
        setTimeout(() => {
          countRefreshButtons();
        }, 1000);
      }
    });
  </script>
</body>
</html>
