<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test localStorage vs Firebase Conflict</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .storage-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .storage-box {
      background: #2a2a2a;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 15px;
    }
    
    .storage-box.localStorage {
      border-color: #e74c3c;
    }
    
    .storage-box.firebase {
      border-color: #00b894;
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 3px;
      font-size: 13px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    .btn--warning { background: #f39c12; }
    
    .status {
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 13px;
    }
    
    .status.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
    .status.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
    .status.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
    .status.warning { background: rgba(243, 156, 18, 0.2); border: 1px solid #f39c12; }
    
    .movie-list {
      background: #1a1a1a;
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
      min-height: 100px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .movie-item {
      background: #333;
      padding: 6px 10px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      background: #333;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-size: 12px;
    }
    
    .log-area {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
    }
    
    .force-mode-indicator {
      background: #6c5ce7;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }
    
    .force-mode-indicator.active {
      background: #00b894;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Test localStorage vs Firebase Conflict</h1>
    <p>Test xem localStorage c√≥ can thi·ªáp v√†o Firebase sync kh√¥ng</p>
    
    <!-- Current Status -->
    <div class="test-section">
      <h3>üìä Current System Status</h3>
      
      <div class="user-info" id="current-user-info">
        Loading user info...
      </div>
      
      <div class="force-mode-indicator" id="force-mode-indicator">
        Force Firebase Mode: Checking...
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="refreshStatus()">üîÑ Refresh Status</button>
        <button class="btn btn--warning" onclick="toggleForceMode()">üöÄ Toggle Force Mode</button>
        <button class="btn btn--danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
      </div>
    </div>

    <!-- Storage Comparison -->
    <div class="test-section">
      <h3>‚öñÔ∏è Storage Comparison</h3>
      
      <div class="storage-comparison">
        <!-- localStorage -->
        <div class="storage-box localStorage">
          <h4 style="color: #e74c3c; margin: 0 0 10px 0;">üì± localStorage</h4>
          
          <div class="movie-list" id="localstorage-movies">
            <div style="color: #888; text-align: center; padding: 20px;">
              Loading...
            </div>
          </div>
          
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button class="btn" onclick="addLocalMovie()">‚ûï Add Local</button>
            <button class="btn" onclick="loadLocalMovies()">üìö Load Local</button>
            <button class="btn btn--danger" onclick="clearLocalMovies()">üóëÔ∏è Clear Local</button>
          </div>
          
          <div id="localstorage-status" class="status info">Ready</div>
        </div>
        
        <!-- Firebase -->
        <div class="storage-box firebase">
          <h4 style="color: #00b894; margin: 0 0 10px 0;">üî• Firebase</h4>
          
          <div class="movie-list" id="firebase-movies">
            <div style="color: #888; text-align: center; padding: 20px;">
              Loading...
            </div>
          </div>
          
          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button class="btn" onclick="addFirebaseMovie()">‚ûï Add Firebase</button>
            <button class="btn" onclick="loadFirebaseMovies()">üìö Load Firebase</button>
            <button class="btn btn--danger" onclick="clearFirebaseMovies()">üóëÔ∏è Clear Firebase</button>
          </div>
          
          <div id="firebase-status" class="status info">Ready</div>
        </div>
      </div>
    </div>

    <!-- Conflict Test -->
    <div class="test-section">
      <h3>‚öîÔ∏è Conflict Test</h3>
      <p>Test xem Storage.getSavedMovies() tr·∫£ v·ªÅ data t·ª´ ƒë√¢u</p>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="btn btn--success" onclick="testStorageGetSavedMovies()">üß™ Test getSavedMovies()</button>
        <button class="btn btn--warning" onclick="simulateSync()">üîÑ Simulate Sync</button>
        <button class="btn" onclick="testConflictScenario()">‚öîÔ∏è Test Conflict Scenario</button>
      </div>
      
      <div id="conflict-results"></div>
    </div>

    <!-- Debug Log -->
    <div class="test-section">
      <h3>üìù Debug Log</h3>
      <div class="log-area" id="debug-log">
        Debug messages will appear here...
      </div>
      <button class="btn" onclick="clearDebugLog()">üóëÔ∏è Clear Log</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    let debugMessages = [];
    
    // Capture console
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function captureConsole() {
      ['log', 'error', 'warn'].forEach(method => {
        console[method] = function(...args) {
          const message = args.join(' ');
          debugMessages.push(`[${method.toUpperCase()}] ${message}`);
          updateDebugLog();
          originalConsole[method].apply(console, args);
        };
      });
    }
    
    function updateDebugLog() {
      const debugLog = document.getElementById('debug-log');
      const recent = debugMessages.slice(-15);
      debugLog.innerHTML = recent.map(msg => `<div>${msg}</div>`).join('');
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    function clearDebugLog() {
      debugMessages = [];
      updateDebugLog();
    }
    
    function addDebugMessage(message) {
      debugMessages.push(`[TEST] ${message}`);
      updateDebugLog();
    }
    
    function refreshStatus() {
      // Update user info
      if (window.movieComments) {
        const userId = window.movieComments.getUserId();
        const userName = window.movieComments.getUserName();
        const isFirebaseReady = window.movieComments.initialized;
        
        document.getElementById('current-user-info').innerHTML = `
          <div><strong>User ID:</strong> ${userId.substring(0, 30)}...</div>
          <div><strong>User Name:</strong> ${userName}</div>
          <div><strong>Firebase Ready:</strong> ${isFirebaseReady ? '‚úÖ Yes' : '‚ùå No'}</div>
        `;
      }
      
      // Update force mode indicator
      const forceMode = window.Storage?._forceFirebaseMode || false;
      const indicator = document.getElementById('force-mode-indicator');
      indicator.textContent = `Force Firebase Mode: ${forceMode ? 'ACTIVE' : 'INACTIVE'}`;
      indicator.className = forceMode ? 'force-mode-indicator active' : 'force-mode-indicator';
      
      // Load both storage types
      loadLocalMovies();
      loadFirebaseMovies();
      
      addDebugMessage(`üìä Status refreshed - Force mode: ${forceMode}`);
    }
    
    function toggleForceMode() {
      if (window.Storage) {
        window.Storage._forceFirebaseMode = !window.Storage._forceFirebaseMode;
        addDebugMessage(`üöÄ Force Firebase mode: ${window.Storage._forceFirebaseMode ? 'ENABLED' : 'DISABLED'}`);
        refreshStatus();
      }
    }
    
    function clearAllData() {
      // Clear localStorage
      localStorage.removeItem('savedMovies');
      localStorage.removeItem('watchProgress');
      
      // Clear Storage cache
      if (window.Storage) {
        window.Storage._savedMoviesCache = null;
        window.Storage._lastCacheUpdate = 0;
      }
      
      addDebugMessage('üóëÔ∏è Cleared all data');
      refreshStatus();
    }
    
    async function loadLocalMovies() {
      try {
        const localMovies = JSON.parse(localStorage.getItem('savedMovies') || '[]');
        const container = document.getElementById('localstorage-movies');
        
        if (localMovies.length === 0) {
          container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No local movies</div>';
        } else {
          container.innerHTML = localMovies.map(movie => `
            <div class="movie-item">
              <span>üé¨ ${movie.name || movie.slug}</span>
              <span style="font-size: 10px; color: #888;">${new Date(movie.savedAt).toLocaleTimeString()}</span>
            </div>
          `).join('');
        }
        
        document.getElementById('localstorage-status').innerHTML = `üì± ${localMovies.length} movies in localStorage`;
        document.getElementById('localstorage-status').className = 'status info';
        
      } catch (error) {
        document.getElementById('localstorage-status').innerHTML = `‚ùå Error: ${error.message}`;
        document.getElementById('localstorage-status').className = 'status error';
      }
    }
    
    async function loadFirebaseMovies() {
      try {
        if (window.movieComments && window.movieComments.initialized) {
          const firebaseMovies = await window.movieComments.getSavedMovies();
          const container = document.getElementById('firebase-movies');
          
          if (firebaseMovies.length === 0) {
            container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">No Firebase movies</div>';
          } else {
            container.innerHTML = firebaseMovies.map(movie => `
              <div class="movie-item">
                <span>üé¨ ${movie.name || movie.slug}</span>
                <span style="font-size: 10px; color: #888;">${new Date(movie.savedAt).toLocaleTimeString()}</span>
              </div>
            `).join('');
          }
          
          document.getElementById('firebase-status').innerHTML = `üî• ${firebaseMovies.length} movies in Firebase`;
          document.getElementById('firebase-status').className = 'status success';
          
        } else {
          document.getElementById('firebase-status').innerHTML = '‚ùå Firebase not ready';
          document.getElementById('firebase-status').className = 'status error';
        }
      } catch (error) {
        document.getElementById('firebase-status').innerHTML = `‚ùå Error: ${error.message}`;
        document.getElementById('firebase-status').className = 'status error';
      }
    }
    
    function addLocalMovie() {
      const localMovies = JSON.parse(localStorage.getItem('savedMovies') || '[]');
      const newMovie = {
        slug: 'local-movie-' + Date.now(),
        name: 'Local Movie ' + new Date().toLocaleTimeString(),
        savedAt: Date.now()
      };
      
      localMovies.push(newMovie);
      localStorage.setItem('savedMovies', JSON.stringify(localMovies));
      
      addDebugMessage(`‚ûï Added local movie: ${newMovie.name}`);
      loadLocalMovies();
    }
    
    async function addFirebaseMovie() {
      try {
        if (window.Storage) {
          const newMovie = {
            slug: 'firebase-movie-' + Date.now(),
            name: 'Firebase Movie ' + new Date().toLocaleTimeString(),
            year: 2025,
            lang: 'Vietsub'
          };
          
          await window.Storage.saveMovie(newMovie);
          addDebugMessage(`‚ûï Added Firebase movie: ${newMovie.name}`);
          loadFirebaseMovies();
        }
      } catch (error) {
        addDebugMessage(`‚ùå Add Firebase movie error: ${error.message}`);
      }
    }
    
    function clearLocalMovies() {
      localStorage.removeItem('savedMovies');
      addDebugMessage('üóëÔ∏è Cleared localStorage movies');
      loadLocalMovies();
    }
    
    async function clearFirebaseMovies() {
      try {
        if (window.Storage) {
          await window.Storage.clearAllSavedMovies();
          addDebugMessage('üóëÔ∏è Cleared Firebase movies');
          loadFirebaseMovies();
        }
      } catch (error) {
        addDebugMessage(`‚ùå Clear Firebase movies error: ${error.message}`);
      }
    }
    
    async function testStorageGetSavedMovies() {
      try {
        addDebugMessage('üß™ Testing Storage.getSavedMovies()...');
        
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          
          document.getElementById('conflict-results').innerHTML = `
            <div class="status success">
              <strong>‚úÖ Storage.getSavedMovies() Result:</strong><br>
              Found: ${movies.length} movies<br>
              Force Firebase Mode: ${window.Storage._forceFirebaseMode ? 'ACTIVE' : 'INACTIVE'}<br>
              Source: ${window.Storage._forceFirebaseMode ? 'Firebase (forced)' : 'Auto-detected'}
            </div>
          `;
          
          addDebugMessage(`üß™ getSavedMovies() returned ${movies.length} movies`);
        }
      } catch (error) {
        document.getElementById('conflict-results').innerHTML = `
          <div class="status error">‚ùå Test failed: ${error.message}</div>
        `;
        addDebugMessage(`‚ùå Test error: ${error.message}`);
      }
    }
    
    async function simulateSync() {
      try {
        addDebugMessage('üîÑ Simulating sync process...');
        
        // Simulate sync by enabling force Firebase mode
        if (window.Storage) {
          window.Storage._savedMoviesCache = null;
          window.Storage._lastCacheUpdate = 0;
          window.Storage._forceFirebaseMode = true;
        }
        
        // Clear localStorage
        localStorage.removeItem('savedMovies');
        localStorage.removeItem('watchProgress');
        
        addDebugMessage('‚úÖ Sync simulation completed - Force Firebase mode enabled');
        refreshStatus();
        
        document.getElementById('conflict-results').innerHTML = `
          <div class="status warning">
            <strong>üîÑ Sync Simulated:</strong><br>
            Force Firebase Mode: ENABLED<br>
            localStorage: CLEARED<br>
            Cache: CLEARED
          </div>
        `;
        
      } catch (error) {
        addDebugMessage(`‚ùå Simulate sync error: ${error.message}`);
      }
    }
    
    async function testConflictScenario() {
      try {
        addDebugMessage('‚öîÔ∏è Testing conflict scenario...');
        
        // Step 1: Add different movies to localStorage and Firebase
        addLocalMovie();
        await addFirebaseMovie();
        
        // Step 2: Test without force mode
        if (window.Storage) {
          window.Storage._forceFirebaseMode = false;
        }
        
        const moviesWithoutForce = await window.Storage.getSavedMovies();
        
        // Step 3: Test with force mode
        if (window.Storage) {
          window.Storage._forceFirebaseMode = true;
          window.Storage._savedMoviesCache = null; // Clear cache
        }
        
        const moviesWithForce = await window.Storage.getSavedMovies();
        
        document.getElementById('conflict-results').innerHTML = `
          <div class="status info">
            <strong>‚öîÔ∏è Conflict Test Results:</strong><br>
            Without Force Mode: ${moviesWithoutForce.length} movies<br>
            With Force Mode: ${moviesWithForce.length} movies<br>
            Difference: ${Math.abs(moviesWithForce.length - moviesWithoutForce.length)} movies
          </div>
        `;
        
        addDebugMessage(`‚öîÔ∏è Conflict test - Without force: ${moviesWithoutForce.length}, With force: ${moviesWithForce.length}`);
        
      } catch (error) {
        addDebugMessage(`‚ùå Conflict test error: ${error.message}`);
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      captureConsole();
      
      // Initial load
      setTimeout(() => {
        refreshStatus();
        addDebugMessage('üöÄ Conflict test system initialized');
      }, 2000);
      
      // Auto-refresh every 10 seconds
      setInterval(() => {
        refreshStatus();
      }, 10000);
    });
  </script>
</body>
</html>
