<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test One Punch Man Search</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            line-height: 1.8;
        }
        h1 { color: #0ff; }
        h2 { color: #ff0; margin-top: 30px; }
        .result {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #0f0;
            font-size: 14px;
        }
        .error { border-color: #f00; color: #f00; }
        .success { border-color: #0f0; }
        .warning { border-color: #ff0; color: #ff0; }
        code { background: #000; padding: 2px 6px; color: #0ff; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: bold;
        }
        button:hover { background: #0ff; }
        #loading { display: none; color: #ff0; }
    </style>
</head>
<body>
    <h1>üî¨ Test Search: "ƒê·∫•m Ph√°t Ch·∫øt Lu√¥n"</h1>
    <p>Ki·ªÉm tra xem API c√≥ t√¨m ƒë∆∞·ª£c c√°c ph·∫ßn 1, 2, 3 kh√¥ng</p>

    <div>
        <button onclick="testSearch()">üîç Test Search</button>
        <button onclick="testDetection()">üß™ Test Detection</button>
        <button onclick="clearResults()">üóëÔ∏è Clear</button>
    </div>

    <div id="loading">‚è≥ ƒêang t√¨m ki·∫øm...</div>

    <h2>üìä K·∫øt Qu·∫£</h2>
    <div id="results"></div>

    <script>
        const API_BASE = 'https://phimapi.com/v1/api';

        // Detection logic (copy from series-navigator.js)
        function getSeriesBaseInfo(movie) {
          if (!movie || !movie.name) return null;

          const movieName = movie.name.trim();
          
          const patterns = [
            /^(.+?)\s*\(\s*Ph·∫ßn\s*(\d+)\s*\)$/i,
            /^(.+?)\s*\(\s*Season\s*(\d+)\s*\)$/i,
            /^(.+?)\s*-\s*Ph·∫ßn\s*(\d+)$/i,
            /^(.+?)\s*-\s*Season\s*(\d+)$/i
          ];

          for (let i = 0; i < patterns.length; i++) {
            const match = movieName.match(patterns[i]);
            if (match && match.length >= 3) {
              return {
                seriesId: match[1].trim() + '_SERIES',
                season: parseInt(match[2]),
                baseName: match[1].trim(),
                method: 'pattern_' + (i + 1)
              };
            }
          }

          // Fallback: origin_name
          if (movie.origin_name) {
            const originPatterns = [
              /^(.+?)\s*\(\s*Season\s*(\d+)\s*\)$/i,
              /^(.+?)\s*Season\s*(\d+)$/i
            ];

            for (let i = 0; i < originPatterns.length; i++) {
              const match = movie.origin_name.match(originPatterns[i]);
              if (match && match.length >= 3) {
                return {
                  seriesId: match[1].trim() + '_ORIGIN_SERIES',
                  season: parseInt(match[2]),
                  baseName: match[1].trim(),
                  method: 'origin_' + (i + 1)
                };
              }
            }
          }

          return null;
        }

        async function testSearch() {
            const results = document.getElementById('results');
            const loading = document.getElementById('loading');
            
            results.innerHTML = '';
            loading.style.display = 'block';

            try {
                // Test search v·ªõi keyword "ƒê·∫•m Ph√°t Ch·∫øt Lu√¥n"
                const searchKeyword = 'ƒê·∫•m Ph√°t Ch·∫øt Lu√¥n';
                const url = `${API_BASE}/tim-kiem?keyword=${encodeURIComponent(searchKeyword)}&limit=50`;
                
                results.innerHTML += `<div class="result">
                    <strong>üîç Searching:</strong> <code>${searchKeyword}</code><br>
                    <strong>URL:</strong> <code>${url}</code>
                </div>`;

                const response = await fetch(url);
                const data = await response.json();
                
                results.innerHTML += `<div class="result success">
                    <strong>‚úÖ API Response:</strong><br>
                    Status: ${data.status ? '‚úÖ Success' : '‚ùå Failed'}<br>
                    Total found: ${data.data?.items?.length || 0} phim
                </div>`;

                if (data.data?.items && data.data.items.length > 0) {
                    // Analyze each result
                    const items = data.data.items;
                    let foundParts = [];

                    results.innerHTML += `<div class="result"><strong>üìã Danh s√°ch t√¨m ƒë∆∞·ª£c:</strong></div>`;

                    items.forEach((movie, index) => {
                        const seriesInfo = getSeriesBaseInfo(movie);
                        const isMatch = movie.name.toLowerCase().includes('ƒë·∫•m ph√°t ch·∫øt lu√¥n') || 
                                      movie.name.toLowerCase().includes('one punch man');

                        if (isMatch) {
                            foundParts.push({
                                name: movie.name,
                                origin_name: movie.origin_name,
                                slug: movie.slug,
                                year: movie.year,
                                seriesInfo: seriesInfo
                            });

                            const seasonNum = seriesInfo ? seriesInfo.season : '?';
                            const detected = seriesInfo ? '‚úÖ Detected' : '‚ùå Not detected';

                            results.innerHTML += `<div class="result ${seriesInfo ? 'success' : 'warning'}">
                                <strong>${index + 1}. ${movie.name}</strong> (${movie.year})<br>
                                Origin: <code>${movie.origin_name || 'N/A'}</code><br>
                                Slug: <code>${movie.slug}</code><br>
                                Detection: ${detected} ${seriesInfo ? `‚Üí Ph·∫ßn ${seasonNum}` : ''}
                            </div>`;
                        }
                    });

                    // Summary
                    if (foundParts.length > 0) {
                        const seasons = foundParts.filter(p => p.seriesInfo).map(p => p.seriesInfo.season).sort((a, b) => a - b);
                        results.innerHTML += `<div class="result success">
                            <strong>üéØ T·ªïng K·∫øt:</strong><br>
                            T√¨m ƒë∆∞·ª£c: ${foundParts.length} ph·∫ßn<br>
                            Detected seasons: ${seasons.length > 0 ? seasons.join(', ') : 'None'}<br>
                            ${seasons.length >= 2 ? '‚úÖ Navigator S·∫º hi·ªÉn th·ªã!' : '‚ùå Navigator KH√îNG hi·ªÉn th·ªã (c·∫ßn ‚â•2 ph·∫ßn)'}
                        </div>`;

                        // Test if they would be grouped together
                        const baseNames = foundParts
                            .filter(p => p.seriesInfo)
                            .map(p => p.seriesInfo.baseName.toLowerCase())
                            .filter((v, i, a) => a.indexOf(v) === i);

                        results.innerHTML += `<div class="result ${baseNames.length === 1 ? 'success' : 'error'}">
                            <strong>üîó Link Test:</strong><br>
                            Unique base names: ${baseNames.length}<br>
                            ${baseNames.map(name => `‚Ä¢ <code>${name}</code>`).join('<br>')}<br>
                            ${baseNames.length === 1 ? '‚úÖ C√°c ph·∫ßn s·∫Ω link v·ªõi nhau' : '‚ùå T√™n base kh√°c nhau ‚Üí KH√îNG link ƒë∆∞·ª£c!'}
                        </div>`;
                    } else {
                        results.innerHTML += `<div class="result error">
                            <strong>‚ùå Kh√¥ng t√¨m th·∫•y phim n√†o match!</strong><br>
                            Keyword c√≥ th·ªÉ kh√¥ng ƒë√∫ng ho·∫∑c phim kh√¥ng c√≥ trong API
                        </div>`;
                    }
                } else {
                    results.innerHTML += `<div class="result error">
                        <strong>‚ùå Kh√¥ng c√≥ k·∫øt qu·∫£!</strong><br>
                        API kh√¥ng tr·∫£ v·ªÅ phim n√†o
                    </div>`;
                }

            } catch (error) {
                results.innerHTML += `<div class="result error">
                    <strong>üí• Error:</strong><br>
                    ${error.message}<br>
                    <small>${error.stack}</small>
                </div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function testDetection() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="result"><strong>üß™ Testing Detection Logic</strong></div>';

            const testCases = [
                { name: "ƒê·∫•m Ph√°t Ch·∫øt Lu√¥n (Ph·∫ßn 1)", origin_name: "One Punch Man (Season 1)" },
                { name: "ƒê·∫•m Ph√°t Ch·∫øt Lu√¥n (Ph·∫ßn 2)", origin_name: "One Punch Man (Season 2)" },
                { name: "ƒê·∫•m Ph√°t Ch·∫øt Lu√¥n (Ph·∫ßn 3)", origin_name: "One Punch Man (Season 3)" },
                { name: "ƒê·∫•m Ph√°t Ch·∫øt Lu√¥n", origin_name: "One Punch Man" }
            ];

            testCases.forEach((movie, index) => {
                const result = getSeriesBaseInfo(movie);
                results.innerHTML += `<div class="result ${result ? 'success' : 'warning'}">
                    <strong>Test ${index + 1}:</strong> <code>${movie.name}</code><br>
                    Result: ${result ? `‚úÖ Season ${result.season}, Base: "${result.baseName}"` : '‚ùå Not detected'}
                </div>`;
            });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-run on load
        console.log('üî¨ Test page loaded. Click "Test Search" to start.');
    </script>
</body>
</html>
