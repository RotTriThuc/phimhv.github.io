<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Sync Dialog Fix</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 10px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .status.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
    .status.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
    .status.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
    
    .browser-info {
      background: #2a2a2a;
      border: 2px solid #00b894;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: monospace;
    }
    
    .log-area {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Test Sync Dialog Fix</h1>
    <p>Test fix cho l·ªói "_getBrowserInfo is not a function"</p>
    
    <!-- Browser Detection Test -->
    <div class="test-section">
      <h3>üîç Browser Detection Test</h3>
      
      <div class="browser-info" id="browser-info">
        <div><strong>User Agent:</strong> <span id="user-agent">Loading...</span></div>
        <div><strong>Detected Browser:</strong> <span id="detected-browser">Loading...</span></div>
        <div><strong>Function Available:</strong> <span id="function-status">Checking...</span></div>
      </div>
      
      <button class="btn" onclick="testBrowserDetection()">üîç Test Browser Detection</button>
      
      <div id="browser-test-results"></div>
    </div>

    <!-- Sync Dialog Test -->
    <div class="test-section">
      <h3>üîÑ Sync Dialog Test</h3>
      <p>Test m·ªü sync dialog ƒë·ªÉ verify kh√¥ng c√≥ l·ªói "_getBrowserInfo is not a function"</p>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn--success" onclick="testSyncDialog()">üîÑ Open Sync Dialog</button>
        <button class="btn" onclick="testBrowserInfoInDialog()">üîç Test Browser Info</button>
      </div>
      
      <div id="sync-dialog-results"></div>
    </div>

    <!-- Function Availability Test -->
    <div class="test-section">
      <h3>‚öôÔ∏è Function Availability Test</h3>
      <p>Ki·ªÉm tra t·∫•t c·∫£ functions c·∫ßn thi·∫øt c√≥ available kh√¥ng</p>
      
      <div id="function-availability">
        <div style="color: #888;">Click "Test Functions" ƒë·ªÉ ki·ªÉm tra</div>
      </div>
      
      <button class="btn" onclick="testFunctionAvailability()">‚öôÔ∏è Test Functions</button>
    </div>

    <!-- Error Simulation -->
    <div class="test-section">
      <h3>üö® Error Simulation</h3>
      <p>Simulate l·ªói ƒë·ªÉ test error handling</p>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn--danger" onclick="simulateError()">üö® Simulate Error</button>
        <button class="btn" onclick="testErrorHandling()">üõ°Ô∏è Test Error Handling</button>
      </div>
      
      <div id="error-simulation-results"></div>
    </div>

    <!-- Debug Log -->
    <div class="test-section">
      <h3>üìù Debug Log</h3>
      <div class="log-area" id="debug-log">
        Debug messages will appear here...
      </div>
      <button class="btn" onclick="clearDebugLog()">üóëÔ∏è Clear Log</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    let debugMessages = [];
    
    // Capture console
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function captureConsole() {
      ['log', 'error', 'warn'].forEach(method => {
        console[method] = function(...args) {
          const message = args.join(' ');
          debugMessages.push(`[${method.toUpperCase()}] ${message}`);
          updateDebugLog();
          originalConsole[method].apply(console, args);
        };
      });
    }
    
    function updateDebugLog() {
      const debugLog = document.getElementById('debug-log');
      const recent = debugMessages.slice(-15);
      debugLog.innerHTML = recent.map(msg => `<div>${msg}</div>`).join('');
      debugLog.scrollTop = debugLog.scrollHeight;
    }
    
    function clearDebugLog() {
      debugMessages = [];
      updateDebugLog();
    }
    
    function addDebugMessage(message) {
      debugMessages.push(`[TEST] ${message}`);
      updateDebugLog();
    }
    
    function testBrowserDetection() {
      try {
        // Show user agent
        const userAgent = navigator.userAgent;
        document.getElementById('user-agent').textContent = userAgent.substring(0, 100) + '...';
        
        // Test browser detection
        if (window.movieComments && window.movieComments._getBrowserInfo) {
          const detectedBrowser = window.movieComments._getBrowserInfo();
          document.getElementById('detected-browser').textContent = detectedBrowser;
          document.getElementById('function-status').textContent = '‚úÖ Available';
          document.getElementById('function-status').style.color = '#00b894';
          
          document.getElementById('browser-test-results').innerHTML = `
            <div class="status success">
              ‚úÖ Browser detection working correctly!<br>
              Detected: <strong>${detectedBrowser}</strong>
            </div>
          `;
          
          addDebugMessage(`Browser detection successful: ${detectedBrowser}`);
          
        } else {
          document.getElementById('detected-browser').textContent = 'Function not available';
          document.getElementById('function-status').textContent = '‚ùå Not Available';
          document.getElementById('function-status').style.color = '#e74c3c';
          
          document.getElementById('browser-test-results').innerHTML = `
            <div class="status error">
              ‚ùå _getBrowserInfo function not available
            </div>
          `;
          
          addDebugMessage('ERROR: _getBrowserInfo function not available');
        }
        
      } catch (error) {
        document.getElementById('browser-test-results').innerHTML = `
          <div class="status error">‚ùå Browser detection error: ${error.message}</div>
        `;
        addDebugMessage(`Browser detection error: ${error.message}`);
      }
    }
    
    function testSyncDialog() {
      try {
        addDebugMessage('Testing sync dialog...');
        
        if (window.movieComments && window.movieComments.showSyncDialog) {
          window.movieComments.showSyncDialog();
          
          document.getElementById('sync-dialog-results').innerHTML = `
            <div class="status success">
              ‚úÖ Sync dialog opened successfully!<br>
              No "_getBrowserInfo is not a function" error
            </div>
          `;
          
          addDebugMessage('Sync dialog opened successfully');
          
        } else {
          document.getElementById('sync-dialog-results').innerHTML = `
            <div class="status error">‚ùå showSyncDialog function not available</div>
          `;
          addDebugMessage('ERROR: showSyncDialog function not available');
        }
        
      } catch (error) {
        document.getElementById('sync-dialog-results').innerHTML = `
          <div class="status error">‚ùå Sync dialog error: ${error.message}</div>
        `;
        addDebugMessage(`Sync dialog error: ${error.message}`);
      }
    }
    
    function testBrowserInfoInDialog() {
      try {
        if (window.movieComments && window.movieComments._getBrowserInfo) {
          const browserInfo = window.movieComments._getBrowserInfo();
          
          // Create a mock dialog content to test browser info display
          const mockDialogContent = `
            <div style="background: #2a2a2a; padding: 15px; border-radius: 8px;">
              <div>Thi·∫øt b·ªã hi·ªán t·∫°i:</div>
              <div>Tr√¨nh duy·ªát: ${browserInfo}</div>
            </div>
          `;
          
          document.getElementById('sync-dialog-results').innerHTML = `
            <div class="status success">
              ‚úÖ Browser info in dialog works correctly!
            </div>
            <div style="margin-top: 15px;">
              <strong>Preview:</strong>
              ${mockDialogContent}
            </div>
          `;
          
          addDebugMessage(`Browser info in dialog: ${browserInfo}`);
          
        } else {
          document.getElementById('sync-dialog-results').innerHTML = `
            <div class="status error">‚ùå _getBrowserInfo function not available for dialog</div>
          `;
        }
        
      } catch (error) {
        document.getElementById('sync-dialog-results').innerHTML = `
          <div class="status error">‚ùå Browser info test error: ${error.message}</div>
        `;
        addDebugMessage(`Browser info test error: ${error.message}`);
      }
    }
    
    function testFunctionAvailability() {
      const functions = [
        '_getBrowserInfo',
        'showSyncDialog',
        'getUserId',
        'getUserName',
        'generateSyncCode',
        'useSyncCode',
        '_getSeamlessDeviceId',
        '_checkSeamlessAutoSync'
      ];
      
      let availabilityHtml = '<div><strong>Function Availability:</strong></div>';
      let allAvailable = true;
      
      functions.forEach(funcName => {
        const isAvailable = window.movieComments && typeof window.movieComments[funcName] === 'function';
        const status = isAvailable ? '‚úÖ' : '‚ùå';
        const color = isAvailable ? '#00b894' : '#e74c3c';
        
        availabilityHtml += `
          <div style="margin: 5px 0; color: ${color};">
            ${status} ${funcName}: ${isAvailable ? 'Available' : 'Not Available'}
          </div>
        `;
        
        if (!isAvailable) allAvailable = false;
        
        addDebugMessage(`Function ${funcName}: ${isAvailable ? 'Available' : 'Not Available'}`);
      });
      
      if (allAvailable) {
        availabilityHtml += `
          <div class="status success" style="margin-top: 15px;">
            ‚úÖ All functions are available!
          </div>
        `;
      } else {
        availabilityHtml += `
          <div class="status error" style="margin-top: 15px;">
            ‚ùå Some functions are missing
          </div>
        `;
      }
      
      document.getElementById('function-availability').innerHTML = availabilityHtml;
    }
    
    function simulateError() {
      try {
        // Try to call a non-existent function to simulate the original error
        if (window.movieComments) {
          // This should work now
          const browserInfo = window.movieComments._getBrowserInfo();
          
          document.getElementById('error-simulation-results').innerHTML = `
            <div class="status success">
              ‚úÖ No error! _getBrowserInfo works correctly<br>
              Result: <strong>${browserInfo}</strong>
            </div>
          `;
          
          addDebugMessage(`Error simulation: Function works correctly - ${browserInfo}`);
          
        } else {
          throw new Error('movieComments not available');
        }
        
      } catch (error) {
        document.getElementById('error-simulation-results').innerHTML = `
          <div class="status error">‚ùå Simulated error: ${error.message}</div>
        `;
        addDebugMessage(`Simulated error: ${error.message}`);
      }
    }
    
    function testErrorHandling() {
      try {
        // Test various error scenarios
        const tests = [
          {
            name: 'Browser Info Function',
            test: () => window.movieComments._getBrowserInfo()
          },
          {
            name: 'User ID Function',
            test: () => window.movieComments.getUserId()
          },
          {
            name: 'User Name Function',
            test: () => window.movieComments.getUserName()
          }
        ];
        
        let resultsHtml = '<div><strong>Error Handling Test Results:</strong></div>';
        let allPassed = true;
        
        tests.forEach(test => {
          try {
            const result = test.test();
            resultsHtml += `
              <div style="color: #00b894; margin: 5px 0;">
                ‚úÖ ${test.name}: Success (${typeof result === 'string' ? result.substring(0, 20) + '...' : result})
              </div>
            `;
            addDebugMessage(`${test.name}: Success`);
          } catch (error) {
            resultsHtml += `
              <div style="color: #e74c3c; margin: 5px 0;">
                ‚ùå ${test.name}: ${error.message}
              </div>
            `;
            allPassed = false;
            addDebugMessage(`${test.name}: Error - ${error.message}`);
          }
        });
        
        if (allPassed) {
          resultsHtml += `
            <div class="status success" style="margin-top: 15px;">
              ‚úÖ All error handling tests passed!
            </div>
          `;
        } else {
          resultsHtml += `
            <div class="status error" style="margin-top: 15px;">
              ‚ùå Some error handling tests failed
            </div>
          `;
        }
        
        document.getElementById('error-simulation-results').innerHTML = resultsHtml;
        
      } catch (error) {
        document.getElementById('error-simulation-results').innerHTML = `
          <div class="status error">‚ùå Error handling test failed: ${error.message}</div>
        `;
        addDebugMessage(`Error handling test failed: ${error.message}`);
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      captureConsole();
      
      // Initial setup
      setTimeout(() => {
        testBrowserDetection();
        testFunctionAvailability();
        addDebugMessage('üöÄ Sync dialog fix test initialized');
      }, 1000);
    });
  </script>
</body>
</html>
