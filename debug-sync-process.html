<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Sync Process</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #121212;
      color: #fff;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .debug-section {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .btn {
      background: #6c5ce7;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    
    .btn:hover { opacity: 0.8; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn--success { background: #00b894; }
    .btn--danger { background: #e74c3c; }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .status.success { background: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; }
    .status.error { background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; }
    .status.info { background: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; }
    
    .code-block {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 10px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .user-info {
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .sync-input {
      width: 150px;
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: #fff;
      text-align: center;
      font-size: 16px;
      letter-spacing: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Debug Sync Process</h1>
    <p>Debug t·∫°i sao phim kh√¥ng hi·ªÉn th·ªã sau khi sync</p>
    
    <!-- Current User Info -->
    <div class="debug-section">
      <h3>üë§ Current User Info</h3>
      <div class="user-info" id="current-user-info">
        Loading user info...
      </div>
      <button class="btn" onclick="refreshUserInfo()">üîÑ Refresh User Info</button>
    </div>

    <!-- Saved Movies Status -->
    <div class="debug-section">
      <h3>üìö Saved Movies Status</h3>
      <div id="movies-status" class="status info">Checking saved movies...</div>
      <div id="movies-list" class="code-block">
        Loading movies...
      </div>
      <button class="btn" onclick="loadSavedMovies()">üìö Load Saved Movies</button>
      <button class="btn" onclick="clearMoviesCache()">üóëÔ∏è Clear Cache</button>
    </div>

    <!-- Sync Test -->
    <div class="debug-section">
      <h3>üîÑ Sync Test</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <!-- Generate Sync Code -->
        <div>
          <h4>üì§ Generate Sync Code</h4>
          <button class="btn btn--success" onclick="generateTestSyncCode()">Generate Code</button>
          <div id="generated-code" style="margin: 10px 0; font-size: 18px; font-weight: bold; text-align: center; color: #6c5ce7;">
            -
          </div>
        </div>
        
        <!-- Use Sync Code -->
        <div>
          <h4>üì• Use Sync Code</h4>
          <input type="text" id="sync-code-input" class="sync-input" placeholder="123456" maxlength="6">
          <button class="btn btn--success" onclick="testSyncCode()">Apply Sync</button>
        </div>
      </div>
      
      <div id="sync-results" style="margin-top: 15px;"></div>
    </div>

    <!-- Manual Tests -->
    <div class="debug-section">
      <h3>üß™ Manual Tests</h3>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" onclick="testSaveMovie()">üíæ Save Test Movie</button>
        <button class="btn" onclick="testGetMovies()">üìö Get Movies</button>
        <button class="btn" onclick="testUserIdChange()">üîÑ Test User ID Change</button>
        <button class="btn" onclick="simulateSync()">üé≠ Simulate Full Sync</button>
      </div>
      
      <div id="manual-test-results"></div>
    </div>

    <!-- Console Log -->
    <div class="debug-section">
      <h3>üìù Console Log</h3>
      <div class="code-block" id="console-log">
        Console messages will appear here...
      </div>
      <button class="btn" onclick="clearConsoleLog()">üóëÔ∏è Clear Log</button>
    </div>
  </div>

  <!-- Load Firebase and App -->
  <script src="./firebase-config.js"></script>
  <script src="./assets/app.js"></script>
  
  <script>
    let consoleMessages = [];
    
    // Capture console messages
    const originalConsole = {
      log: console.log,
      error: console.error,
      warn: console.warn
    };
    
    function captureConsole() {
      ['log', 'error', 'warn'].forEach(method => {
        console[method] = function(...args) {
          const message = args.join(' ');
          consoleMessages.push(`[${method.toUpperCase()}] ${message}`);
          updateConsoleLog();
          originalConsole[method].apply(console, args);
        };
      });
    }
    
    function updateConsoleLog() {
      const consoleLog = document.getElementById('console-log');
      const recent = consoleMessages.slice(-20);
      consoleLog.innerHTML = recent.map(msg => `<div>${msg}</div>`).join('');
      consoleLog.scrollTop = consoleLog.scrollHeight;
    }
    
    function clearConsoleLog() {
      consoleMessages = [];
      updateConsoleLog();
    }
    
    function refreshUserInfo() {
      if (window.movieComments) {
        const userId = window.movieComments.getUserId();
        const userName = window.movieComments.getUserName();
        const isFirebaseReady = window.movieComments.initialized;
        
        document.getElementById('current-user-info').innerHTML = `
          <div><strong>User ID:</strong> ${userId}</div>
          <div><strong>User Name:</strong> ${userName}</div>
          <div><strong>Firebase Ready:</strong> ${isFirebaseReady ? '‚úÖ Yes' : '‚ùå No'}</div>
          <div><strong>localStorage ID:</strong> ${localStorage.getItem('movie_commenter_id') || 'None'}</div>
          <div><strong>sessionStorage ID:</strong> ${sessionStorage.getItem('movie_commenter_id') || 'None'}</div>
        `;
        
        console.log('üë§ Current user info:', { userId, userName, isFirebaseReady });
      } else {
        document.getElementById('current-user-info').innerHTML = '‚ùå movieComments not available';
      }
    }
    
    async function loadSavedMovies() {
      try {
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          
          document.getElementById('movies-status').innerHTML = `‚úÖ Found ${movies.length} saved movies`;
          document.getElementById('movies-status').className = 'status success';
          
          if (movies.length > 0) {
            const moviesList = movies.map((movie, index) => 
              `${index + 1}. ${movie.name || movie.slug} (Saved: ${new Date(movie.savedAt).toLocaleString()})`
            ).join('\n');
            
            document.getElementById('movies-list').innerHTML = moviesList;
          } else {
            document.getElementById('movies-list').innerHTML = 'No movies found';
          }
          
          console.log('üìö Loaded movies:', movies);
        } else {
          document.getElementById('movies-status').innerHTML = '‚ùå Storage not available';
          document.getElementById('movies-status').className = 'status error';
        }
      } catch (error) {
        document.getElementById('movies-status').innerHTML = `‚ùå Error: ${error.message}`;
        document.getElementById('movies-status').className = 'status error';
        console.error('‚ùå Load movies error:', error);
      }
    }
    
    function clearMoviesCache() {
      if (window.Storage) {
        window.Storage._savedMoviesCache = null;
        localStorage.removeItem('savedMovies');
        console.log('üóëÔ∏è Cleared movies cache');
        loadSavedMovies();
      }
    }
    
    function generateTestSyncCode() {
      if (window.movieComments && window.movieComments.generateSyncCode) {
        const code = window.movieComments.generateSyncCode();
        document.getElementById('generated-code').textContent = code;
        console.log('üì§ Generated sync code:', code);
      } else {
        alert('‚ùå generateSyncCode not available');
      }
    }
    
    async function testSyncCode() {
      const syncCode = document.getElementById('sync-code-input').value.trim();
      if (!syncCode) {
        alert('‚ùå Please enter a sync code');
        return;
      }
      
      try {
        if (window.movieComments && window.movieComments.useSyncCode) {
          console.log('üîÑ Testing sync with code:', syncCode);
          
          // Log before sync
          const beforeUserId = window.movieComments.getUserId();
          const beforeMovies = await window.Storage.getSavedMovies();
          console.log('üìä Before sync:', { beforeUserId, movieCount: beforeMovies.length });
          
          // Apply sync
          const result = await window.movieComments.useSyncCode(syncCode);
          
          // Log after sync
          const afterUserId = window.movieComments.getUserId();
          const afterMovies = await window.Storage.getSavedMovies();
          console.log('üìä After sync:', { afterUserId, movieCount: afterMovies.length });
          
          document.getElementById('sync-results').innerHTML = `
            <div class="status success">
              <strong>‚úÖ Sync Successful!</strong><br>
              Synced with: ${result.userName}<br>
              User ID: ${result.userId}<br>
              Movies before: ${beforeMovies.length}<br>
              Movies after: ${afterMovies.length}
            </div>
          `;
          
          // Refresh displays
          refreshUserInfo();
          loadSavedMovies();
          
        } else {
          alert('‚ùå useSyncCode not available');
        }
      } catch (error) {
        document.getElementById('sync-results').innerHTML = `
          <div class="status error">
            <strong>‚ùå Sync Failed!</strong><br>
            Error: ${error.message}
          </div>
        `;
        console.error('‚ùå Sync error:', error);
      }
    }
    
    async function testSaveMovie() {
      try {
        const testMovie = {
          slug: 'test-movie-' + Date.now(),
          name: 'Test Movie ' + new Date().toLocaleTimeString(),
          poster_url: 'https://via.placeholder.com/300x400',
          year: 2025,
          lang: 'Vietsub'
        };
        
        if (window.Storage) {
          await window.Storage.saveMovie(testMovie);
          console.log('üíæ Saved test movie:', testMovie.name);
          loadSavedMovies();
        }
      } catch (error) {
        console.error('‚ùå Save movie error:', error);
      }
    }
    
    async function testGetMovies() {
      try {
        if (window.Storage) {
          const movies = await window.Storage.getSavedMovies();
          console.log('üìö Get movies result:', movies);
          
          document.getElementById('manual-test-results').innerHTML = `
            <div class="status info">
              <strong>Get Movies Result:</strong><br>
              Found: ${movies.length} movies<br>
              User ID: ${window.movieComments?.getUserId()}<br>
              Firebase: ${window.movieComments?.initialized ? 'Ready' : 'Not Ready'}
            </div>
          `;
        }
      } catch (error) {
        console.error('‚ùå Get movies error:', error);
      }
    }
    
    function testUserIdChange() {
      const newUserId = 'test_user_' + Date.now();
      localStorage.setItem('movie_commenter_id', newUserId);
      sessionStorage.setItem('movie_commenter_id', newUserId);
      
      console.log('üîÑ Changed user ID to:', newUserId);
      refreshUserInfo();
      loadSavedMovies();
    }
    
    async function simulateSync() {
      console.log('üé≠ Simulating full sync process...');
      
      // Step 1: Save current state
      const originalUserId = window.movieComments?.getUserId();
      const originalMovies = await window.Storage?.getSavedMovies() || [];
      
      console.log('üìä Original state:', { originalUserId, movieCount: originalMovies.length });
      
      // Step 2: Change user ID (simulate sync)
      const newUserId = 'synced_user_' + Date.now();
      localStorage.setItem('movie_commenter_id', newUserId);
      sessionStorage.setItem('movie_commenter_id', newUserId);
      
      // Step 3: Clear cache
      if (window.Storage) {
        window.Storage._savedMoviesCache = null;
      }
      localStorage.removeItem('savedMovies');
      
      console.log('üîÑ Simulated sync to user:', newUserId);
      
      // Step 4: Load movies with new user ID
      const newMovies = await window.Storage?.getSavedMovies() || [];
      console.log('üìä New state:', { newUserId, movieCount: newMovies.length });
      
      // Update displays
      refreshUserInfo();
      loadSavedMovies();
      
      document.getElementById('manual-test-results').innerHTML = `
        <div class="status info">
          <strong>üé≠ Sync Simulation Complete:</strong><br>
          Original User: ${originalUserId}<br>
          Original Movies: ${originalMovies.length}<br>
          New User: ${newUserId}<br>
          New Movies: ${newMovies.length}
        </div>
      `;
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      captureConsole();
      
      // Initial load
      setTimeout(() => {
        refreshUserInfo();
        loadSavedMovies();
      }, 2000);
      
      // Auto-refresh every 5 seconds
      setInterval(() => {
        refreshUserInfo();
      }, 5000);
    });
    
    // Auto-format sync code input
    document.getElementById('sync-code-input').oninput = (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    };
  </script>
</body>
</html>
