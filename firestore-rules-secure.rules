rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ‚ù§Ô∏è SAVED MOVIES COLLECTION  
    // Ch·ªâ cho ph√©p user ƒë·ªçc/ghi phim c·ªßa ch√≠nh m√¨nh
    match /savedMovies/{document} {
      // Cho ph√©p ƒë·ªçc n·∫øu l√† phim c·ªßa user hi·ªán t·∫°i
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Cho ph√©p t·∫°o m·ªõi n·∫øu userId trong data kh·ªõp v·ªõi auth uid
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      
      // Cho ph√©p update/delete n·∫øu l√† phim c·ªßa ch√≠nh m√¨nh
      allow update, delete: if request.auth != null 
                            && resource.data.userId == request.auth.uid;
    }
    
    // üì∫ WATCH PROGRESS COLLECTION
    match /watchProgress/{document} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null 
                            && resource.data.userId == request.auth.uid;
    }
    
    // üë§ USERS COLLECTION
    match /users/{userId} {
      allow read: if true; // Public profiles
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // üîê SYNC CODES COLLECTION
    match /syncCodes/{document} {
      allow read: if request.auth != null;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // üí¨ MOVIE COMMENTS COLLECTION
    match /movieComments/{document} {
      allow read: if true; // Comments l√† public
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null 
                            && request.auth.uid == resource.data.authorId;
    }
    
    // üí¨ COMMENTS COLLECTION (legacy)
    match /comments/{document} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null 
                            && request.auth.uid == resource.data.userId;
    }
    
    // üìä ANALYTICS COLLECTION
    match /analytics/{document} {
      allow read: if true;
      allow write: if false; // Ch·ªâ server ƒë∆∞·ª£c ghi
    }
    
    // üîî NOTIFICATIONS COLLECTION
    match /notifications/{document} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null 
                            && request.auth.uid == resource.data.userId;
    }
  }
}
